

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>libra_py.pdos &mdash; Libra 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Libra
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/libra_py.html">libra_py</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Libra</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>libra_py.pdos</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for libra_py.pdos</h1><div class="highlight"><pre>
<span></span><span class="c1">#*********************************************************************************</span>
<span class="c1">#* Copyright (C) 2018-2019 Alexey V. Akimov</span>
<span class="c1">#*</span>
<span class="c1">#* This file is distributed under the terms of the GNU General Public License</span>
<span class="c1">#* as published by the Free Software Foundation, either version 2 of</span>
<span class="c1">#* the License, or (at your option) any later version.</span>
<span class="c1">#* See the file LICENSE in the root directory of this distribution</span>
<span class="c1">#* or &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#*</span>
<span class="c1">#*********************************************************************************/</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: pdos</span>
<span class="sd">   :platform: Unix, Windows</span>
<span class="sd">   :synopsis: </span>
<span class="sd">       This module implements functions for computing Projected (Partial) </span>
<span class="sd">       Densities of States (pDOS) from various outputs</span>

<span class="sd">.. moduleauthor:: Alexey V. Akimov</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s2">&quot;cygwin&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cyglibra_core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s2">&quot;linux&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s2">&quot;linux2&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">liblibra_core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">import</span> <span class="nn">util.libutil</span> <span class="k">as</span> <span class="nn">comn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<div class="viewcode-block" id="convolve"><a class="viewcode-back" href="../../reference/libra_py/pdos.html#libra_py.pdos.convolve">[docs]</a><span class="k">def</span> <span class="nf">convolve</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="n">Y0</span><span class="p">,</span> <span class="n">dx0</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function convolves the original data with the Gaussian</span>
<span class="sd">    of a given width:  exp(- (x - x0)^2 / (2*var^2) )</span>
<span class="sd">    This also means the energy grid spacing may change (usually to a denser one)</span>
<span class="sd">    The difference in grid densities is defined by the multiplicative factor dx0/dx</span>

<span class="sd">    Args:</span>
<span class="sd">        X0 ( MATRIX(N0, 1) ): original X grid, N0 - the number of energy grid points</span>
<span class="sd">        Y0 ( MATRIX(N0, Nproj) ): original Y grids, Nproj - the number of projections</span>
<span class="sd">            to consider</span>
<span class="sd">        dx0 ( double ): original X grid spacing [in units of energy]</span>
<span class="sd">        dx ( double ): new X grid spacing [in units of energy]</span>
<span class="sd">        var ( double ): width of the Gaussians that broaden the original data [in units of energy]</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: ( X, Y ), where:</span>

<span class="sd">            * X ( MATRIX(N, 1) ): new X grid, N - the new number of energy grid points (N*dx = N0*dx0)</span>
<span class="sd">            * Y ( MATRIX(N, Nproj) ): new Y grids, Nproj has the same meaning as in Y0</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mult</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dx0</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span>     <span class="c1"># making grid mult times bigger</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;multiplication factor is = &quot;</span><span class="p">,</span> <span class="n">mult</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;original grid spacing = &quot;</span><span class="p">,</span> <span class="n">dx0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new grid spacing = &quot;</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gaussian variance = &quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        
    <span class="c1"># Prepare arrays</span>
    <span class="n">N0</span>    <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">num_of_rows</span>     <span class="c1"># how many original grid points</span>
    <span class="n">nproj</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">num_of_cols</span>     <span class="c1"># how many components</span>
    <span class="n">N</span>  <span class="o">=</span> <span class="n">N0</span><span class="o">*</span><span class="n">mult</span>               <span class="c1"># how many new grid points</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>           <span class="c1"># new X axis</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nproj</span><span class="p">)</span>       <span class="c1"># new Y axes</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="n">X</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">X0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>


    <span class="n">area</span> <span class="o">=</span> <span class="n">var</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>  <span class="c1"># area under Gaussian of type exp( -(x - x0)^2 / 2*var^2 ) </span>
    <span class="n">alp</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="n">var</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nproj</span><span class="p">):</span>  

        <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N0</span><span class="p">):</span>   <span class="c1"># all initial grid points</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">X0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

            <span class="n">area0</span> <span class="o">=</span> <span class="n">dx0</span><span class="o">*</span><span class="n">y0</span>      <span class="c1"># initial area</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">area0</span><span class="o">/</span><span class="n">area</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">w</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alp</span><span class="o">*</span><span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span></div>




<div class="viewcode-block" id="QE_pdos"><a class="viewcode-back" href="../../reference/libra_py/pdos.html#libra_py.pdos.QE_pdos">[docs]</a><span class="k">def</span> <span class="nf">QE_pdos</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">projections</span><span class="p">,</span> <span class="n">Ef</span><span class="p">,</span> <span class="n">outfile_prefix</span><span class="p">,</span> <span class="n">do_convolve</span><span class="p">,</span> <span class="n">de_new</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">nspin</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes various types of pDOS from the atomic state projections generated by the QE</span>

<span class="sd">    Args:</span>
<span class="sd">        prefix ( string ): a common prefix of the filenames for files containing the projection information</span>
<span class="sd">        emin ( double ): the minimal energy of the pDOS window [eV]</span>
<span class="sd">        emax ( double ): maximal energy of the pDOS window [eV]</span>
<span class="sd">        de ( double ): the original grid spacing of the pDOS [eV] (not necessarily the one used in pdos.in)</span>
<span class="sd">        projections ( list of lists of - see below): groups of atoms and types of projections.</span>
<span class="sd">            Each element of this list contains 3 sub-lists, whose intersection defines which files to use:</span>
<span class="sd">            e.g. projection = [[&quot;s&quot;,&quot;p&quot;], [1,2,3], [&quot;Cs&quot;, &quot;Br&quot;]] - means s and p orbitals of atoms 1, 2, and 3</span>
<span class="sd">            as long as any of these atoms are Cs or Br</span>
<span class="sd">        Ef ( double ): which energy use as the origin of energy scale (zero) in the output. Usually </span>
<span class="sd">            the Fermi or LUMO energy</span>
<span class="sd">        outfile_prefix ( string ): the prefix of the output file that will contain the final projections</span>
<span class="sd">        do_convolve ( Bool ): the flag telling whether we want to convolve the original data with the</span>
<span class="sd">            Gaussian envelope. The convolution is done with :func:`convolve`</span>
<span class="sd">        de_new ( double ): the new energy grid spacing [eV], in effect only if do_convolve == True</span>
<span class="sd">        var ( double ): standard deviation of the Gaussian [eV] with which we do a convolution, </span>
<span class="sd">            in effect only if do_convolve == True</span>
<span class="sd">        nspin ( int): specifies which nspin was used in the electronic structure calculation.</span>
<span class="sd">                      nspin = 1      </span>
<span class="sd">                      nspin = 2</span>
<span class="sd">                      nspin = 4</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: ( E, pDOSa ), where:</span>

<span class="sd">            * E ( MATRIX(N, 1) ): new energy grid, N - the new number of energy grid points</span>
<span class="sd">            * pDOSa ( MATRIX(N, Nproj) ): new Y grids, Nproj - len(projections) the number of projections we are interested in</span>
<span class="sd">            * if spin = 2, returns pDOSb for beta spin-orbtials as well</span>
<span class="sd">            * if spin = 4, returns just the pDOSa (pDOSb = None), but the orbitals now mixed spin states </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">nspin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Error: The value of nspin must be either 1, 2, or 4&quot;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;nspin = 1: Spin-unpolarized&quot;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;nspin = 2: Spin-polarized&quot;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;nspin = 4: Spin-non-colinear&quot;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Exiting Now ...&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#============= Dimensions  =================</span>

    <span class="n">nproj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span>                <span class="c1"># number of projections</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">emax</span> <span class="o">-</span> <span class="n">emin</span><span class="p">)</span><span class="o">/</span><span class="n">de</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># number of the gridpoints</span>

    <span class="n">en</span>   <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>      <span class="c1"># energy of the grid points</span>
    <span class="n">dosa</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nproj</span><span class="p">)</span>  <span class="c1"># Matrix for alpha spin-orbitals dos.get(i,proj) - dos for level i projected on projection proj</span>
    <span class="n">dosb</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nproj</span><span class="p">)</span>  <span class="c1"># Matrix for beta  spin-orbitals</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="n">en</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emin</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">de</span> <span class="o">-</span> <span class="n">Ef</span><span class="p">)</span>

        <span class="c1">#============= Data gathering  =================</span>

    <span class="k">for</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">projections</span><span class="p">:</span>  <span class="c1"># loop over all projection</span>
        <span class="n">ang_mom</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">proj_indx</span> <span class="o">=</span> <span class="n">projections</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span> <span class="c1"># open files for atoms with given indices (indexing from 1)</span>
            <span class="k">for</span> <span class="n">symb</span> <span class="ow">in</span> <span class="n">ang_mom</span><span class="p">:</span>  <span class="c1"># for given angular momentum labels</span>
                <span class="k">for</span> <span class="n">wfc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># Specify max wfc type index - usually no more than 3, 5 - should be more than enough  </span>
                    <span class="k">for</span> <span class="n">Elt</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span> <span class="c1"># for given atom names</span>

                        <span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]:</span> <span class="c1"># total angular momentum label</span>
                                <span class="n">filename</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="n">Elt</span><span class="o">+</span><span class="s2">&quot;)_wfc#&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wfc</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="n">symb</span><span class="o">+</span><span class="s2">&quot;_j&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>

                                    <span class="n">fa</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                                    <span class="n">B</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                                    <span class="n">check</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                                    <span class="n">fa</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                                    <span class="k">for</span> <span class="n">lin</span> <span class="ow">in</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># read all lines, except for the header</span>
                                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lin</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                                        <span class="n">e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="k">if</span> <span class="n">e</span><span class="o">&lt;</span><span class="n">emin</span> <span class="ow">or</span> <span class="n">e</span><span class="o">&gt;</span><span class="n">emax</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">state_indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">emin</span><span class="p">)</span><span class="o">/</span><span class="n">de</span><span class="p">))</span>
                                            <span class="n">dosa</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state_indx</span><span class="p">,</span> <span class="n">proj_indx</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                        <span class="k">else</span><span class="p">:</span>

                            <span class="n">filename</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="n">Elt</span><span class="o">+</span><span class="s2">&quot;)_wfc#&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wfc</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="n">symb</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>  <span class="c1"># file </span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>

                                <span class="n">fa</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                                <span class="n">B</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                                <span class="n">check</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                                <span class="n">fa</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                                <span class="k">for</span> <span class="n">lin</span> <span class="ow">in</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># read all lines, except for the header</span>
                                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">lin</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                                    <span class="n">e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="n">e</span><span class="o">&lt;</span><span class="n">emin</span> <span class="ow">or</span> <span class="n">e</span><span class="o">&gt;</span><span class="n">emax</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">state_indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">emin</span><span class="p">)</span><span class="o">/</span><span class="n">de</span><span class="p">))</span>
                                        <span class="n">dosa</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state_indx</span><span class="p">,</span> <span class="n">proj_indx</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                        <span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">check</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ldosdw(E)&quot;</span><span class="p">:</span>
                                            <span class="n">dosb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state_indx</span><span class="p">,</span> <span class="n">proj_indx</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1">#============= Optional convolution =================</span>

    <span class="n">E</span><span class="p">,</span> <span class="n">pDOSa</span><span class="p">,</span> <span class="n">pDOSb</span> <span class="o">=</span> <span class="n">en</span><span class="p">,</span> <span class="n">dosa</span><span class="p">,</span> <span class="n">dosb</span>
    <span class="k">if</span> <span class="n">do_convolve</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">E</span><span class="p">,</span> <span class="n">pDOSa</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">dosa</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">de_new</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">E</span><span class="p">,</span> <span class="n">pDOSb</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">dosb</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">de_new</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c1">#============= Print out ==================</span>
    <span class="n">f2a</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="o">+</span><span class="s2">&quot;_alp.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">);</span> <span class="n">f2a</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">f2b</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="o">+</span><span class="s2">&quot;_bet.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">);</span> <span class="n">f2b</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">num_of_rows</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>  <span class="c1"># loop over grid points</span>
        <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;   &quot;</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nproj</span><span class="p">):</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="n">tot</span> <span class="o">+</span> <span class="n">pDOSa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pDOSa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;   &quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">f2a</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="o">+</span><span class="s2">&quot;_alp.txt&quot;</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">f2a</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">f2a</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>  <span class="c1"># loop over grid points</span>
        <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;   &quot;</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nproj</span><span class="p">):</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="n">tot</span> <span class="o">+</span> <span class="n">pDOSb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pDOSb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;   &quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">f2b</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="o">+</span><span class="s2">&quot;_bet.txt&quot;</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">f2b</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">f2b</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">E</span><span class="p">,</span> <span class="n">pDOSa</span><span class="p">,</span> <span class="n">pDOSb</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pDOSb</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">pDOSa</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">E</span><span class="p">,</span> <span class="n">pDOSa</span><span class="p">,</span> <span class="n">pDOSb</span></div>



<div class="viewcode-block" id="libra_pdos"><a class="viewcode-back" href="../../reference/libra_py/pdos.html#libra_py.pdos.libra_pdos">[docs]</a><span class="k">def</span> <span class="nf">libra_pdos</span><span class="p">(</span><span class="n">_emin</span><span class="p">,</span> <span class="n">_emax</span><span class="p">,</span> <span class="n">_de</span><span class="p">,</span> <span class="n">projections</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">Nel</span><span class="p">,</span> <span class="n">do_convolve</span><span class="p">,</span> <span class="n">_de_new</span><span class="p">,</span> <span class="n">_var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">    </span>
<span class="sd">        * _emin ( double ): minimal energy of the spectrum [eV]</span>
<span class="sd">        </span>
<span class="sd">        * _emax ( double ): maximal energy of the spectrum [eV]</span>
<span class="sd">        </span>
<span class="sd">        * _de ( double ): original energy grid spacing  [eV]</span>
<span class="sd">        </span>
<span class="sd">        * projections ( list ):  groups of atoms and types of projections </span>
<span class="sd">            e.g. projections = [[&quot;s&quot;,[1,2,3]], [&quot;p&quot;,[1,2,3]], ... </span>
<span class="sd">            </span>
<span class="sd">            Possible projections (examples)</span>
<span class="sd">            proj = [[&quot;s&quot;,range(0,360)],[&quot;p&quot;,range(0,360)],[&quot;d&quot;,range(0,360)]]</span>
<span class="sd">            proj = [[&quot;s&quot;,range(0,1)],[&quot;p&quot;,range(0,1)],[&quot;d&quot;,range(0,1)]]</span>
<span class="sd">            proj = [[&quot;tot&quot;,range(0,112)]]</span>

<span class="sd">            </span>
<span class="sd">        * prefix ( string ): the common prefix of the files containing the projection information</span>
<span class="sd">        </span>
<span class="sd">        * outfile ( string ): the name of the file that will contain the computed pDOSs</span>
<span class="sd">        </span>
<span class="sd">        * Nel ( int ): the number of electrons, to compute the Fermi energy</span>
<span class="sd">            </span>
<span class="sd">        * _de_new ( double ): new energy grid (for convolved) spacing  [eV]</span>
<span class="sd">        </span>
<span class="sd">        * _var ( double ): the width of the Gaussian used to broaden each energy grid point [eV] </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    # Example: of call - for Si QD</span>
<span class="sd">    # Si</span>
<span class="sd">    #main(-35.0, 35.0, 0.1,[[&quot;tot&quot;,range(0,103)]],&quot;_alpha_wfc_atom&quot;,&quot;dos_proj.txt&quot;,238)   </span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Internally, we work in a.u. (Ha)</span>
    <span class="n">emin</span> <span class="o">=</span> <span class="n">_emin</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">ev2Ha</span>
    <span class="n">emax</span> <span class="o">=</span> <span class="n">_emax</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">ev2Ha</span>
    <span class="n">de</span> <span class="o">=</span> <span class="n">_de</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">ev2Ha</span>
    <span class="n">de_new</span> <span class="o">=</span> <span class="n">_de_new</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">ev2Ha</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">_var</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">ev2Ha</span>

    <span class="c1"># Determine dimensionality and prepare arrays</span>
    <span class="n">nproj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span>                <span class="c1"># number of projections</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">emax</span> <span class="o">-</span> <span class="n">emin</span><span class="p">)</span><span class="o">/</span><span class="n">de</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># number of the gridpoints</span>

    <span class="n">en0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dosa</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nproj</span><span class="p">)</span>  <span class="c1"># Matrix for alpha spin-orbitals dos.get(i,proj) - dos for level i projected on projection proj</span>
    <span class="n">dosb</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nproj</span><span class="p">)</span>  <span class="c1"># Matrix for beta  spin-orbitals</span>
    
    
    <span class="k">for</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">projections</span><span class="p">:</span>  <span class="c1"># loop over all projection</span>
        <span class="n">ang_mom</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">proj_indx</span> <span class="o">=</span> <span class="n">projections</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
                                            
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span> <span class="c1"># open files for all atoms in given group</span>
            <span class="n">fa</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">fa</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">lin</span> <span class="ow">in</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]:</span>  <span class="c1"># read all lines</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">lin</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                 
                <span class="n">e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># energy in Ha</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">en0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  
                
                <span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">ang_mom</span><span class="o">==</span><span class="s2">&quot;s&quot;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">ang_mom</span><span class="o">==</span><span class="s2">&quot;p&quot;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">ang_mom</span><span class="o">==</span><span class="s2">&quot;d&quot;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">ang_mom</span><span class="o">==</span><span class="s2">&quot;tot&quot;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="n">e</span><span class="o">&lt;</span><span class="n">emin</span> <span class="ow">or</span> <span class="n">e</span><span class="o">&gt;</span><span class="n">emax</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grid_indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">emin</span><span class="p">)</span><span class="o">/</span><span class="n">de</span><span class="p">))</span>  <span class="c1"># grid point</span>
                    <span class="n">dosa</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">grid_indx</span><span class="p">,</span> <span class="n">proj_indx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="n">dosb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">grid_indx</span><span class="p">,</span> <span class="n">proj_indx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


    
    <span class="n">etol</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">kT</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">ev2Ha</span> <span class="c1"># some reasonable parameters</span>
    <span class="n">Ef</span> <span class="o">=</span> <span class="n">fermi_energy</span><span class="p">(</span><span class="n">en0</span><span class="p">,</span> <span class="n">Nel</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">kT</span><span class="p">,</span> <span class="n">etol</span><span class="p">)</span>  <span class="c1"># Fermi energy in Ha</span>
    

    <span class="n">en</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="n">en</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emin</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">de</span> <span class="o">-</span> <span class="n">Ef</span><span class="p">)</span>

    
    <span class="n">E</span> <span class="o">=</span> <span class="kc">None</span>                
    <span class="k">if</span> <span class="n">do_convolve</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">E</span><span class="p">,</span> <span class="n">pDOSa</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">dosa</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">de_new</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="c1">#E, pDOSb = convolve(en0, dosb, de, de_new, var)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">dosa</span><span class="p">)</span>
            
    <span class="c1"># Convert the energy axis back to eV </span>
    <span class="n">E</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">units</span><span class="o">.</span><span class="n">ev2Ha</span><span class="p">)</span>

        
    <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Ef = </span><span class="si">%5.3f</span><span class="s2"> eV</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Ef</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">ev2Ha</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">f2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nproj</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="c1"># Now compute projections</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>  <span class="c1"># loop energy grid</span>

        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
        <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;   &quot;</span>

        <span class="n">tot</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nproj</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDOSa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="n">tot</span> <span class="o">+</span> <span class="n">pDOSa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pDOSa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;   &quot;</span>
            
        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">nproj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">f2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    

    <span class="k">return</span> <span class="n">res</span></div>
    

<div class="viewcode-block" id="convolve_cp2k_pdos"><a class="viewcode-back" href="../../reference/libra_py/pdos.html#libra_py.pdos.convolve_cp2k_pdos">[docs]</a><span class="k">def</span> <span class="nf">convolve_cp2k_pdos</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads the pdos file produced by CP2K and extract the pdos at each time step and </span>
<span class="sd">    then convolve them with Gaussian functions.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">    </span>
<span class="sd">        params (dictionary):</span>
<span class="sd">    </span>
<span class="sd">            cp2k_pdos_file (str): The CP2K .pdos file.</span>
<span class="sd">        </span>
<span class="sd">            time_step (int): The time step of molecular dynamics.</span>
<span class="sd">        </span>
<span class="sd">            sigma (float): The standard deviation in Gaussian function.</span>
<span class="sd">        </span>
<span class="sd">            coef (float): The coefficient multiplied in Gaussian function.</span>
<span class="sd">        </span>
<span class="sd">            npoints (int): The number of points used in convolution.</span>
<span class="sd">        </span>
<span class="sd">            energy_conversion (float): The energy conversion unit from Hartree. For example 27.211386 is</span>
<span class="sd">                                       for unit conversion from Hartree to eV. This value comes from libra_py.units. For example</span>
<span class="sd">                                       for Hartree to eV one needs to call libra_py.units.au2ev in the input. The default value is </span>
<span class="sd">                                       Hartree to eV.</span>
<span class="sd">				   </span>
<span class="sd">            angular_momentum_cols (list): The angular momentum columns in the *.pdos files produced by CP2K.</span>
<span class="sd">	</span>
<span class="sd">    Returns:</span>
<span class="sd">	</span>
<span class="sd">        energy_grid (numpy array): The energy grid points vector.</span>
<span class="sd">		</span>
<span class="sd">        convolved_pdos (numpy array): The convolved pDOS vector.</span>
<span class="sd">		</span>
<span class="sd">        homo_energy (float): The average HOMO energy.</span>
<span class="sd">		</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Critical parameters</span>
    <span class="n">critical_params</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;cp2k_pdos_file&quot;</span><span class="p">,</span> <span class="s2">&quot;angular_momentum_cols&quot;</span><span class="p">]</span>
    <span class="c1"># Default parameters</span>
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;time_step&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s2">&quot;coef&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;npoints&quot;</span><span class="p">:</span> <span class="mi">4000</span><span class="p">,</span> <span class="s2">&quot;energy_conversion&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">au2ev</span> <span class="p">}</span>
    <span class="c1"># Check input</span>
    <span class="n">comn</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span> <span class="n">critical_params</span><span class="p">)</span> 

    <span class="c1"># The CP2K log file name</span>
    <span class="n">cp2k_pdos_file</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;cp2k_pdos_file&quot;</span><span class="p">]</span>
    <span class="c1"># The time step in the .pdos file (This is for molecular dynamics, for single-point calculations it is set to 0).</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;time_step&quot;</span><span class="p">]</span>
    <span class="c1"># The standard deviation value</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
    <span class="c1"># The pre factor that is multiplied to the Gaussian function</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;coef&quot;</span><span class="p">]</span>
    <span class="c1"># Number of points for the grid </span>
    <span class="n">npoints</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;npoints&quot;</span><span class="p">]</span>
    <span class="c1"># The energy conversion value from atomic unit, It is better to use the default values in the `libra_py.units`</span>
    <span class="n">energy_conversion</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;energy_conversion&quot;</span><span class="p">]</span>
    <span class="c1"># The angular momentum columns in the .pdos files</span>
    <span class="n">angular_momentum_cols</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;angular_momentum_cols&quot;</span><span class="p">]</span>

    <span class="c1"># Opening the file</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cp2k_pdos_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1"># Lines with &#39;DOS&#39;</span>
    <span class="n">lines_with_dos</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Finding the lines with &#39;DOS&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
        <span class="k">if</span> <span class="s1">&#39;DOS&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">lines_with_dos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="c1"># Finding the first and last index of PDOS for each time step</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines_with_dos</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># First index</span>
        <span class="n">first_index</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="c1"># Last index</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines_with_dos</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># First index</span>
        <span class="n">first_index</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="c1"># Last index</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines_with_dos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Find the number of columns in the PDOS file showing the number </span>
    <span class="c1"># of orbital components, energy, and occupation column.</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">first_index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    
    <span class="c1"># Number of energy levels considered for PDOS</span>
    <span class="n">num_levels</span> <span class="o">=</span> <span class="n">last_index</span> <span class="o">-</span> <span class="n">first_index</span> <span class="o">+</span> <span class="mi">1</span>

    
    <span class="c1"># Finding the homo and lumo energy level by appending the </span>
    <span class="c1"># pdos numerical values of unoccupied states only</span>
    <span class="n">pdos_unocc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Energy levels</span>
    <span class="n">energy_levels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_index</span><span class="p">,</span> <span class="n">last_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">energy_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">energy_conversion</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">pdos_unocc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># HOMO energy level</span>
    <span class="n">homo_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">pdos_unocc</span><span class="p">)]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># HOMO energy</span>
    <span class="n">homo_energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">homo_level</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">energy_conversion</span>
    <span class="c1"># Minimum energy level</span>
    <span class="n">min_energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">first_index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">energy_conversion</span>
    <span class="c1"># Maximum energy level</span>
    <span class="n">max_energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">last_index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">energy_conversion</span>
    
    
    <span class="c1"># Now we make an equispaced energy vector from min_energy ad max_energy with npoints.</span>
    <span class="n">energy_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="n">min_energy</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_energy</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">npoints</span> <span class="p">)</span>
    <span class="n">energy_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_grid</span><span class="p">)</span>
    
    
    <span class="c1"># Appending the energy lines with their component densities of states</span>
    <span class="n">energy_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># The initial line in the .pdos file of step &#39;time_step&#39;</span>
    <span class="n">init_line</span>  <span class="o">=</span> <span class="n">time_step</span> <span class="o">*</span> <span class="p">(</span> <span class="n">num_levels</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="c1"># The final line in the .pdos file of step &#39;time_step&#39;</span>
    <span class="n">final_line</span> <span class="o">=</span> <span class="p">(</span> <span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">num_levels</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">init_line</span><span class="p">,</span> <span class="n">final_line</span> <span class="p">):</span>
        <span class="c1"># Appending the energy lines into enrgy_lines</span>
        <span class="n">energy_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy_lines</span><span class="p">)):</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            
            <span class="n">energy_lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy_lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            
    <span class="n">energy_lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_lines</span><span class="p">)</span>

    <span class="c1"># Now we sum the PDOSs defined in angular_momentum_cols by user</span>
    <span class="n">pdos_sum</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy_lines</span><span class="p">)):</span>
        
        <span class="c1"># A temporary vector for summation of the PDOS</span>
        <span class="n">tmp_vec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmp_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy_lines</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">angular_momentum_cols</span><span class="p">)):</span>
            <span class="c1"># Initializing a new sum variable</span>
            <span class="c1"># print(&quot;angular_momentum_cols[i]&quot;,angular_momentum_cols[i])</span>
            <span class="n">tmp_sum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">angular_momentum_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                
                <span class="c1"># If j is less than the number of columns </span>
                <span class="c1"># then sum the PDOS</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&lt;=</span><span class="n">num_cols</span><span class="p">:</span>
                    <span class="n">tmp_sum</span> <span class="o">+=</span> <span class="n">energy_lines</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># Appending tmp_sum into tmp_vec</span>
            <span class="n">tmp_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_sum</span><span class="p">)</span>
        
        <span class="c1"># Now append tmp_vec into pdos_sum, we will</span>
        <span class="c1"># then use this pdos_sum for convolution</span>
        <span class="n">pdos_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_vec</span><span class="p">)</span>
    
    <span class="n">convolved_pdos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># The pre-factor for Gaussian functions</span>
    <span class="n">pre_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">coef</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">angular_momentum_cols</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Initialize a vector of zeros summing the weighted PDOS</span>
        <span class="n">tmp_weighted_pdos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">energy_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_levels</span><span class="p">):</span>
            <span class="c1"># The Guassian function</span>
            <span class="n">gaussian_fun</span> <span class="o">=</span> <span class="n">pre_factor</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(((</span><span class="n">energy_grid</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">pdos_sum</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">energy_conversion</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">),</span><span class="mi">2</span><span class="p">)))</span>
            
            <span class="n">tmp_weighted_pdos</span> <span class="o">=</span> <span class="n">tmp_weighted_pdos</span> <span class="o">+</span> <span class="n">gaussian_fun</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span> <span class="n">pdos_sum</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">convolved_pdos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_weighted_pdos</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Elapsed time for convolving &#39;</span><span class="p">,</span><span class="n">cp2k_pdos_file</span><span class="p">,</span><span class="s1">&#39;: &#39;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="s1">&#39; seconds&#39;</span><span class="p">)</span>
    <span class="n">convolved_pdos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">convolved_pdos</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">energy_grid</span><span class="p">,</span> <span class="n">convolved_pdos</span><span class="p">,</span> <span class="n">homo_energy</span></div>
   
   
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Alexey V. Akimov.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>