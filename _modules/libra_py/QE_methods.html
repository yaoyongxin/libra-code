

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>libra_py.QE_methods &mdash; Libra 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Libra
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/libra_py.html">libra_py</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Libra</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>libra_py.QE_methods</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for libra_py.QE_methods</h1><div class="highlight"><pre>
<span></span><span class="c1">#*********************************************************************************</span>
<span class="c1">#* Copyright (C) 2018-2019 Brendan A. Smith, Alexey V. Akimov</span>
<span class="c1">#* Copyright (C) 2016-2017 Alexey V. Akimov</span>
<span class="c1">#*</span>
<span class="c1">#* This file is distributed under the terms of the GNU General Public License</span>
<span class="c1">#* as published by the Free Software Foundation, either version 2 of</span>
<span class="c1">#* the License, or (at your option) any later version.</span>
<span class="c1">#* See the file LICENSE in the root directory of this distribution</span>
<span class="c1">#* or &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#*</span>
<span class="c1">#*********************************************************************************/</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: QE_methods</span>
<span class="sd">   :platform: Unix, Windows</span>
<span class="sd">   :synopsis: This module implements functions for dealing with the outputs from QE (Quantum Espresso) package.</span>
<span class="sd">       This package contains the following functions:</span>
<span class="sd">           * cryst2cart(a1,a2,a3,r)</span>
<span class="sd">           * read_qe_schema(filename, verbose=0)</span>
<span class="sd">           * read_qe_index(filename, orb_list, verbose=0)</span>
<span class="sd">           * read_qe_wfc_info(filename, verbose=0)</span>
<span class="sd">           * read_qe_wfc_grid(filename, verbose=0)</span>
<span class="sd">           * read_qe_wfc(filename, orb_list, verbose=0)</span>
<span class="sd">           * read_md_data(filename)</span>
<span class="sd">           * read_md_data_xyz(filename, PT, dt)</span>
<span class="sd">           * read_md_data_xyz2(filename, PT)   </span>
<span class="sd">           * read_md_data_cell(filename)</span>
<span class="sd">           * out2inp(out_filename,templ_filename,wd,prefix,t0,tmax,dt)</span>
<span class="sd">           * out2pdb(out_filename,T,dt,pdb_prefix)</span>
<span class="sd">           * out2xyz(out_filename,T,dt,xyz_filename)</span>
<span class="sd">           * xyz2inp(out_filename,templ_filename,wd,prefix,t0,tmax,dt)</span>
<span class="sd">           * get_QE_normal_modes(filename, verbosity=0)</span>
<span class="sd">           * run_qe(params, t, dirname0, dirname1)</span>
<span class="sd">           * read_info(params)</span>
<span class="sd">           * read_all(params)</span>
<span class="sd">           * read_wfc_grid(params)</span>

<span class="sd">.. moduleauthor:: Alexey V. Akimov,  Brendan A. Smith</span>
<span class="sd">  </span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s2">&quot;cygwin&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cyglibra_core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s2">&quot;linux&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s2">&quot;linux2&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">liblibra_core</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">util.libutil</span> <span class="k">as</span> <span class="nn">comn</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">QE_utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">regexlib</span> <span class="k">as</span> <span class="n">rgl</span>

<div class="viewcode-block" id="cryst2cart"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.cryst2cart">[docs]</a><span class="k">def</span> <span class="nf">cryst2cart</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Crystal to Cartesian coordinate conversion </span>

<span class="sd">    An auxiliary function that convert vector &lt;r&gt; in crystal (alat) </span>
<span class="sd">    coordinates with the cell defined by vectors a1, a2, a3, to the</span>
<span class="sd">    Cartesian coordinate xyz</span>

<span class="sd">    Args:</span>
<span class="sd">        a1 ( [double, double, double] ): one of the unit cell/periodicty vectors</span>
<span class="sd">        a2 ( [double, double, double] ): one of the unit cell/periodicty vectors</span>
<span class="sd">        a3 ( [double, double, double] ): one of the unit cell/periodicty vectors</span>
<span class="sd">        r ( [double, double, double] ): Crystal (fractional) coordinates of the atom</span>


<span class="sd">    Returns:</span>
<span class="sd">        [double, double, double]: the Cartesian coordinates of an atom</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x</span></div>



<div class="viewcode-block" id="read_qe_schema"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_qe_schema">[docs]</a><span class="k">def</span> <span class="nf">read_qe_schema</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This functions reads an ASCII/XML format file containing basic info about the QE run</span>

<span class="sd">    Args:</span>
<span class="sd">        filename ( string ): This is the name of the file we will be read [ usually: &quot;x0.save/data-file-schema.xml&quot;]</span>
<span class="sd">        verbose ( int ): The flag controlling the amout of extra output:</span>
<span class="sd">        </span>
<span class="sd">            * 0 - no extra output (default)</span>
<span class="sd">            * 1 - print extra stuff</span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">        dictionary: ( info ): the dictionary containaining the descritive information about the QE calculations and the system</span>

<span class="sd">            It contains the following info:</span>

<span class="sd">            * **info[&quot;conv&quot;]** ( int ): the number of steps to converge SCF, 0 - means no convergence</span>
<span class="sd">            * **info[&quot;etot&quot;]** ( double ): the total energy (electronic + nuclear) [ units: Ha ]</span>
<span class="sd">            * **info[&quot;nbnd&quot;]** ( int ): the number of bands </span>
<span class="sd">            * **info[&quot;nelec&quot;]** ( int ): the number of electrons</span>
<span class="sd">            * **info[&quot;efermi&quot;]** ( double ): the Fermi energy [ units: Ha ] </span>
<span class="sd">            * **info[&quot;alat&quot;]** ( double ): lattice constant [ units: Bohr ] </span>
<span class="sd">            * **info[&quot;nat&quot;]** ( int ): the number of atoms</span>
<span class="sd">            * **info[&quot;coords&quot;]** ( MATRIX(3*nat, 1) ): the atomic coordinates [ units: Bohr ]</span>
<span class="sd">            * **info[&quot;atom_labels&quot;]** ( list of nat strings ): the atomic names</span>
<span class="sd">            * **info[&quot;forces&quot;]** ( MATRIX(3*nat, 1) ): the atomic forces [ units: Ha/Bohr ]</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c1">#(&quot;x.save/data-file-schema.xml&quot;)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_path_separator</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
     

    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;conv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output/convergence_info/scf_conv/n_scf_steps&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">))</span> <span class="c1"># 0 means not converged</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;etot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output/total_energy/etot&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">)</span>   <span class="c1"># total energy</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output/band_structure/nbnd&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">))</span>  
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nelec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output/band_structure/nelec&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">))</span> 
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;efermi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output/band_structure/fermi_energy&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">)</span>


    <span class="n">dctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
    <span class="n">alat</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_structure&quot;</span><span class="p">,</span><span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&lt;xmlattr&gt;/alat&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;alat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">alat</span><span class="p">)</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_structure&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_positions&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;atom&quot;</span><span class="p">)</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nat</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># coordinates</span>
    <span class="n">L</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># labels</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nat</span><span class="p">):</span>        
        <span class="n">xyz_str</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&lt;xmlattr&gt;/name&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;atom_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>


    <span class="c1">#===== Get the forces =======</span>
    <span class="n">pool1</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;forces&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">pool2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">pool1</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
            <span class="n">pool2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        
    <span class="n">forces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pool2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>        
            <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">forces</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;In read_qe_schema: Something is wrong with reading forces</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forces</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># forces</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">):</span>        
        <span class="n">F</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">forces</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;forces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span>


    <span class="k">return</span> <span class="n">info</span></div>



<div class="viewcode-block" id="read_qe_index"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_qe_index">[docs]</a><span class="k">def</span> <span class="nf">read_qe_index</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">orb_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This functions reads an ASCII/XML format file containing wavefunction</span>
<span class="sd">    and returns the coefficients of the plane waves that constitute the</span>
<span class="sd">    wavefunction</span>

<span class="sd">    Args:</span>
<span class="sd">        filename ( string ): This is the name of the file we will be reading to construct a wavefunction</span>
<span class="sd">        orb_list ( list of ints ): The indices of the orbitals which we want to consider. Orbitals indexing </span>
<span class="sd">            at 1, not 0</span>
<span class="sd">        verbose ( int ): The flag controlling the amout of extra output:</span>
<span class="sd">        </span>
<span class="sd">            * 0 - no extra output (default)</span>
<span class="sd">            * 1 - print extra stuff</span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">        tuple: ( info, all_e ), where:</span>

<span class="sd">            * info ( dictionary ): contains all the descritive information about the QE calculations and the system</span>

<span class="sd">                It contains the following info:</span>

<span class="sd">                * **info[&quot;nspin&quot;]** ( int ): the type of calculations: 1 - non-polarized, 2 - polarized, 4 - non-collinear</span>
<span class="sd">                * **info[&quot;nk&quot;]** ( int ): the number of k-points</span>
<span class="sd">                * **info[&quot;nbnd&quot;]** ( int ): the number of orbitals in each k-point</span>
<span class="sd">                * **info[&quot;efermi&quot;]** ( double ): the Fermi energy [units: a.u.]</span>
<span class="sd">                * **info[&quot;alat&quot;]** ( double ): lattice constant, a [units: Bohr]</span>
<span class="sd">                * **info[&quot;omega&quot;]** ( double ): unit cell volume [units: Bohr^3]</span>
<span class="sd">                * **info[&quot;tpiba&quot;]** ( double ): reciprocal cell size, 2*pi/a [units: Bohr^-1]</span>
<span class="sd">                * **info[&quot;tpiba2&quot;]** ( double ): squared reciprocal cell size, (2*pi/a)^2 [units: Bohr^-2]</span>
<span class="sd">                * **info[&quot;a1&quot;]** ( VECTOR ): direct lattice vector 1 [units: Bohr]</span>
<span class="sd">                * **info[&quot;a2&quot;]** ( VECTOR ): direct lattice vector 2 [units: Bohr]</span>
<span class="sd">                * **info[&quot;a3&quot;]** ( VECTOR ): direct lattice vector 3 [units: Bohr]</span>
<span class="sd">                * **info[&quot;b1&quot;]** ( VECTOR ): reciprocal lattice vector 1 [units: Bohr^-1]</span>
<span class="sd">                * **info[&quot;b2&quot;]** ( VECTOR ): reciprocal lattice vector 2 [units: Bohr^-1]</span>
<span class="sd">                * **info[&quot;b3&quot;]** ( VECTOR ): reciprocal lattice vector 3 [units: Bohr^-1]</span>
<span class="sd">                * **info[&quot;weights&quot;]** ( list ): weights of all the k-points in evaluating the integrals</span>
<span class="sd">                * **info[&quot;k&quot;]** ( list of VECTOR objects ): coordinates of the k-points [units: tpiba]</span>

<span class="sd">            all_e ( list of CMATRIX(norb, norb) objects ): orbital energies for all the k-points, such that</span>
<span class="sd">                all_e[k] is a diagonal matrix (complex-valued) of orbital energies - only for those that are of interest</span>
<span class="sd">                Here, norb = len(orb_list) and the matrix will only contain numbers that correspond to orbitals defined</span>
<span class="sd">                in the orb_list argument [units: a.u.]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Ry2Ha</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># conversion factor</span>
   
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c1">#(&quot;x.export/index.xml&quot;)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_path_separator</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;path=&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_path</span><span class="p">())</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">show_children</span><span class="p">(</span><span class="s2">&quot;Root/Eigenvalues&quot;</span><span class="p">)</span>  <span class="c1">#(&quot;Kpoint.1&quot;)</span>

    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nspin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Eigenvalues/&lt;xmlattr&gt;/nspin&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span>  <span class="c1"># 1 - non-polarized, 2 - polarized, 4 - non-collinear</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Eigenvalues/&lt;xmlattr&gt;/nk&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span>  <span class="c1"># the number of k-points</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Eigenvalues/&lt;xmlattr&gt;/nbnd&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span>  <span class="c1"># the number of orbitals in each k-point</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;efermi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ry2Ha</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Eigenvalues/&lt;xmlattr&gt;/efermi&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">))</span>  <span class="c1"># Fermi energy</span>

    <span class="c1"># Usially in atomic units!</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;alat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/Data/&lt;xmlattr&gt;/alat&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">))</span>    <span class="c1"># lattice constant (a)</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/Data/&lt;xmlattr&gt;/omega&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">))</span>  <span class="c1"># unit cell volume</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tpiba&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/Data/&lt;xmlattr&gt;/tpiba&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">))</span>  <span class="c1"># 2 pi / a</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tpiba2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/Data/&lt;xmlattr&gt;/tpiba2&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">))</span>  <span class="c1"># ( 2 pi / a )**2</span>

    <span class="c1"># Direct lattice vectors</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/a1/&lt;xmlattr&gt;/xyz&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VECTOR</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/a2/&lt;xmlattr&gt;/xyz&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VECTOR</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/a3/&lt;xmlattr&gt;/xyz&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VECTOR</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>


    <span class="c1"># Reciprocal lattice vectors</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/b1/&lt;xmlattr&gt;/xyz&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VECTOR</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/b2/&lt;xmlattr&gt;/xyz&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VECTOR</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cell/b3/&lt;xmlattr&gt;/xyz&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VECTOR</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>


    <span class="c1"># K-points</span>
    <span class="c1"># Weights of the k-points</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Kmesh/weights&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="c1"># K-point vectors</span>
    <span class="n">K</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Kmesh/k&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">nk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># the number of k-points</span>
    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nk</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">VECTOR</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ik</span><span class="o">+</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ik</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ik</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">K</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span>       

    
    <span class="c1"># All the bands</span>
    <span class="n">all_e</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all bands</span>

    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">e_str</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Eigenvalues/e.</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ik</span><span class="p">,</span><span class="s2">&quot;n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> 
        <span class="n">nbnd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">e_str</span><span class="p">)</span>    

        <span class="n">norbs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orb_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">orb_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="n">nbnd</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orbital &quot;</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="s2">&quot; is outside the range of allowed orbital indices. The maximal value is &quot;</span><span class="p">,</span> <span class="n">nbnd</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orbital &quot;</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="s2">&quot; is outside the range of allowed orbital indices. The minimal value is &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


        <span class="n">e</span> <span class="o">=</span> <span class="n">CMATRIX</span><span class="p">(</span><span class="n">norbs</span><span class="p">,</span><span class="n">norbs</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">orb_list</span><span class="p">:</span>    
            <span class="n">mo_indx</span> <span class="o">=</span> <span class="n">orb_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">band</span><span class="p">)</span> 
        
            <span class="n">ei</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e_str</span><span class="p">[</span><span class="n">band</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># band starts from 1, not 0!</span>
        
            <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">mo_indx</span><span class="p">,</span><span class="n">mo_indx</span><span class="p">,</span> <span class="n">ei</span> <span class="o">*</span> <span class="n">Ry2Ha</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="n">all_e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; nspin = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nspin&quot;</span><span class="p">],</span> <span class="s2">&quot; nk = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">],</span> <span class="s2">&quot; nbnd = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;nbnd&quot;</span><span class="p">],</span> <span class="s2">&quot; efermi = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;efermi&quot;</span><span class="p">],</span> \
        <span class="s2">&quot; alat = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;alat&quot;</span><span class="p">],</span> <span class="s2">&quot; omega = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">],</span> <span class="s2">&quot; tpiba = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tpiba&quot;</span><span class="p">],</span> <span class="s2">&quot; tpiba2 = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tpiba&quot;</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Direct lattice vectors: &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; a1 = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; a2 = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; a3 = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;a3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Reciprocal lattice vectors: &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; b1 = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; b2 = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; b3 = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;b3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; K points: &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="s2">&quot; weight = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">][</span><span class="n">ik</span><span class="p">],</span> <span class="s2">&quot; k = &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Energies of the active orbitals for all k-points: &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ik = &quot;</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
            <span class="n">all_e</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">show_matrix</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">info</span><span class="p">,</span> <span class="n">all_e</span></div>



<div class="viewcode-block" id="read_qe_wfc_info"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_qe_wfc_info">[docs]</a><span class="k">def</span> <span class="nf">read_qe_wfc_info</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This functions reads an ASCII/XML format file containing wavefunction</span>
<span class="sd">    and returns some descriptors</span>

<span class="sd">    Args:</span>
<span class="sd">        filename ( string ): This is the name of the file we will be reading to construct a wavefunction</span>
<span class="sd">        verbose ( int ): The flag controlling the amout of extra output:</span>
<span class="sd">        </span>
<span class="sd">            * 0 - no extra output (default)</span>
<span class="sd">            * 1 - print extra stuff</span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">        dictionary: a dictionary object that will contain key-value pairs with the descriptors</span>

<span class="sd">            * res[&quot;ngw&quot;] ( int ): the number of plane waves needed to represent the orbital</span>
<span class="sd">            * res[&quot;igwx&quot;] ( int ): the number of the G points = plane waves needed to</span>
<span class="sd">                represent the orbital for given k-point. Use this number when working with multiple k-points</span>
<span class="sd">            </span>
<span class="sd">            * res[&quot;nbnd&quot;] ( int ): the number of bands (orbitals)</span>
<span class="sd">            * res[&quot;nspin&quot;] ( int ): the desriptor of the spin-polarisation in the calculation </span>

<span class="sd">                - 1: unpolarized</span>
<span class="sd">                - 2: polarized </span>
<span class="sd">                - 4: non-collinear </span>

<span class="sd">            * res[&quot;gamma_only&quot;]: ( string = &quot;T&quot; or &quot;F&quot; ): T - use the Gamma-point storae trick, F otherwise</span>
<span class="sd">            * res[&quot;ik&quot;] ( int ): index of the k point wfc</span>
<span class="sd">            * res[&quot;nk&quot;] ( int ): the number of k-points in the wfc</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>   

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c1">#(&quot;x.export/wfc.1&quot;)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_path_separator</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;path=&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_path</span><span class="p">())</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ngw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Info/&lt;xmlattr&gt;/ngw&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span>     <span class="c1"># the number of plane waves needed to represent the orbital</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;igwx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Info/&lt;xmlattr&gt;/igwx&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span>   <span class="c1"># the number of the G points = plane waves needed to</span>
                                                                      <span class="c1"># represent the orbital for given k-point. Use this number </span>
                                                                      <span class="c1"># when working with multiple k-points</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;nbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Info/&lt;xmlattr&gt;/nbnd&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span>   <span class="c1"># the number of bands (orbitals)</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;nspin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Info/&lt;xmlattr&gt;/nspin&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span> <span class="c1"># 1 - unpolarized, 2 - polarized, 4 - non-collinear </span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;gamma_only&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Info/&lt;xmlattr&gt;/gamma_only&quot;</span><span class="p">,</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>      <span class="c1"># T - use the Gamma-point storae trick, T - do not use it</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ik&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Info/&lt;xmlattr&gt;/ik&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span>       <span class="c1"># index of the k point wfc</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Info/&lt;xmlattr&gt;/nk&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)))</span>       <span class="c1"># the number of k-points in the wfc</span>


    <span class="k">if</span> <span class="n">verbose</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ngw = &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ngw&quot;</span><span class="p">],</span> <span class="s2">&quot; igwx = &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;igwx&quot;</span><span class="p">],</span>\
              <span class="s2">&quot; nbnd = &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;nbnd&quot;</span><span class="p">],</span> <span class="s2">&quot; nspin = &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;nspin&quot;</span><span class="p">],</span>\
              <span class="s2">&quot; gamma_only = &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;gamma_only&quot;</span><span class="p">],</span>\
              <span class="s2">&quot; ik = &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ik&quot;</span><span class="p">],</span> <span class="s2">&quot; nk = &quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">res</span></div>




<div class="viewcode-block" id="read_qe_wfc_grid"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_qe_wfc_grid">[docs]</a><span class="k">def</span> <span class="nf">read_qe_wfc_grid</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This functions reads an ASCII/XML format file containing grid of G-points for given k-point</span>
<span class="sd">    and returns a list of VECTOR objects</span>

<span class="sd">    Args:</span>
<span class="sd">        filename ( string ): This is the name of the file we will be reading to construct a wavefunction</span>
<span class="sd">        verbose ( int ): The flag controlling the amout of extra output:</span>
<span class="sd">        </span>
<span class="sd">            * 0 - no extra output (default)</span>
<span class="sd">            * 1 - print extra stuff</span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">        VectorList = list of VECTOR objects: the definitions of all G points in the present calculation</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c1">#(&quot;x.export/grid.1&quot;)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_path_separator</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;path=&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_path</span><span class="p">())</span>


    <span class="c1"># G-point vectors</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">VECTORList</span><span class="p">()</span> <span class="c1">#[]</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span><span class="s2">&quot;-1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">ng</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># the number of G-points</span>

    <span class="k">for</span> <span class="n">ig</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ng</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">VECTOR</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ig</span><span class="o">+</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ig</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ig</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">G</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The number of G point on the grid for this k-point = &quot;</span><span class="p">,</span> <span class="n">ng</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; G points: &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ig</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ng</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">ig</span><span class="p">,</span> <span class="s2">&quot; g = &quot;</span><span class="p">,</span> <span class="n">G</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">G</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">G</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    

    <span class="k">return</span> <span class="n">G</span></div>



<div class="viewcode-block" id="read_qe_wfc"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_qe_wfc">[docs]</a><span class="k">def</span> <span class="nf">read_qe_wfc</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">orb_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This functions reads an ASCII/XML format file containing wavefunction</span>
<span class="sd">    and returns the coefficients of the plane waves that constitute the wavefunction</span>

<span class="sd">    Args:</span>
<span class="sd">        filename ( string ): This is the name of the file we will be reading to construct a wavefunction</span>
<span class="sd">        orb_list ( list of ints ): The indices of the orbitals which we want to consider. Orbitals indexing </span>
<span class="sd">            at 1, not 0</span>
<span class="sd">        verbose ( int ): The flag controlling the amout of extra output:</span>
<span class="sd">        </span>
<span class="sd">            * 0 - no extra output (default)</span>
<span class="sd">            * 1 - print extra stuff</span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">        CMATRIX(ngw,norbs): The plane-wave expansion coefficients for all orbitals</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c1">#(&quot;x.export/wfc.1&quot;)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_path_separator</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;path=&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_path</span><span class="p">())</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">read_qe_wfc_info</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">ngw</span><span class="p">,</span> <span class="n">nbnd</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">gamma_only</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;igwx&quot;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;nbnd&quot;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;nspin&quot;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;gamma_only&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">nspin</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">orb_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;In SOC, the very first orbital index must be odd!</span><span class="se">\n</span><span class="s2">Exiting now...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orb_list</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;In SOC, an even number of orbitals must be utilized!</span><span class="se">\n</span><span class="s2">Exiting now...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">wfc_preprocess</span> <span class="o">=</span> <span class="s2">&quot;normalize&quot;</span>
    <span class="k">if</span> <span class="n">gamma_only</span><span class="o">==</span><span class="s2">&quot;T&quot;</span><span class="p">:</span>
        <span class="n">wfc_preprocess</span> <span class="o">=</span> <span class="s2">&quot;restore&quot;</span>


    <span class="n">norbs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orb_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">orb_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="n">nbnd</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orbital &quot;</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="s2">&quot; is outside the range of allowed orbital indices. The maximal value is &quot;</span><span class="p">,</span> <span class="n">nbnd</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orbital &quot;</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="s2">&quot; is outside the range of allowed orbital indices. The minimal value is &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">coeff</span> <span class="o">=</span> <span class="n">CMATRIX</span><span class="p">(</span><span class="n">ngw</span><span class="p">,</span><span class="n">norbs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">orb_list</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_coeff</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Wfc.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">band</span><span class="p">),</span> <span class="s2">&quot;n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_coeff</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sz</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">all_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sz</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># this should be equal to ngw</span>

        <span class="n">mo_indx</span> <span class="o">=</span> <span class="n">orb_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="c1"># - 1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
            <span class="n">coeff</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mo_indx</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>



    <span class="c1">#======== Normalize or restore (gamma-point trick) wavefunction ===============</span>
    <span class="n">coeff2</span> <span class="o">=</span> <span class="n">coeff</span> <span class="c1">#CMATRIX(ngw,norbs)</span>

    <span class="k">if</span> <span class="n">wfc_preprocess</span><span class="o">==</span><span class="s2">&quot;restore&quot;</span><span class="p">:</span>

        <span class="n">coeff2</span> <span class="o">=</span> <span class="n">CMATRIX</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ngw</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">norbs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">norbs</span><span class="p">):</span>
            <span class="n">coeff2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">coeff</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ngw</span><span class="p">):</span>
                <span class="n">coeff2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">coeff</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
                <span class="n">coeff2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">ngw</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">coeff</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span> <span class="p">)</span>

        <span class="n">ngw</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ngw</span> <span class="o">-</span> <span class="mi">1</span>


    <span class="k">if</span> <span class="n">wfc_preprocess</span><span class="o">==</span><span class="s2">&quot;normalize&quot;</span> <span class="ow">or</span> <span class="n">wfc_preprocess</span><span class="o">==</span><span class="s2">&quot;restore&quot;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">nspin</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">nspin</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">norbs</span><span class="p">):</span>
                <span class="n">mo_i</span> <span class="o">=</span> <span class="n">coeff2</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>            
                <span class="n">nrm</span> <span class="o">=</span> <span class="p">(</span><span class="n">mo_i</span><span class="o">.</span><span class="n">H</span><span class="p">()</span> <span class="o">*</span> <span class="n">mo_i</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                <span class="n">nrm</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nrm</span><span class="p">))</span>
        
                <span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ngw</span><span class="p">):</span>
                    <span class="n">coeff2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">nrm</span><span class="o">*</span><span class="n">coeff2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">nspin</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>  <span class="c1"># spinor case</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">norbs</span><span class="o">/</span><span class="mi">2</span><span class="p">)):</span>  <span class="c1"># this will always be even</span>
                <span class="n">mo_i_a</span> <span class="o">=</span> <span class="n">coeff2</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
                <span class="n">mo_i_b</span> <span class="o">=</span> <span class="n">coeff2</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">nrm</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">mo_i_a</span><span class="o">.</span><span class="n">H</span><span class="p">()</span> <span class="o">*</span> <span class="n">mo_i_a</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="p">(</span><span class="n">mo_i_b</span><span class="o">.</span><span class="n">H</span><span class="p">()</span> <span class="o">*</span> <span class="n">mo_i_b</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span> <span class="p">)</span>
                <span class="n">nrm</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nrm</span><span class="p">))</span>
        
                <span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ngw</span><span class="p">):</span>
                    <span class="n">coeff2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="n">nrm</span><span class="o">*</span><span class="n">coeff2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">coeff2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nrm</span><span class="o">*</span><span class="n">coeff2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        

    <span class="k">return</span> <span class="n">coeff2</span></div>



<div class="viewcode-block" id="read_md_data"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_md_data">[docs]</a><span class="k">def</span> <span class="nf">read_md_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in the QE MD data stored in an XML file</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (string): the name of the xml file that contains an MD data</span>
<span class="sd">            this function is specifically tailored for the QE output format</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (R, V, A, M, E), where:</span>

<span class="sd">        * R ( MATRIX(ndof x nsteps-1) ): coordinates of all DOFs for all mid-timesteps [Bohr]</span>
<span class="sd">        * V ( MATRIX(ndof x nsteps-1) ): velocities of all DOFs for all mid-timesteps [a.u. of velocity]</span>
<span class="sd">        * A ( MATRIX(ndof x nsteps-1) ): accelerations of all DOFs for all mid-timesteps [a.u. of acceleration]</span>
<span class="sd">        * M ( MATRIX(ndof x 1) ): masses of all DOFs [a.u. of mass]</span>
<span class="sd">        * E (list of ndof/3): atom names (elements) of all atoms </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default (empty) context object</span>
    <span class="n">dctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>      
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_path_separator</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>   
    <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_structure&quot;</span><span class="p">,</span><span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_positions&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;atom&quot;</span><span class="p">)</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;ion_control&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;md&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;timestep&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">specs</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_species&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;species&quot;</span><span class="p">)</span>
    <span class="n">nspecs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

    <span class="c1">#========== Masses of elements =============</span>
    <span class="n">PT</span> <span class="o">=</span> <span class="p">{}</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nspecs</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&lt;xmlattr&gt;/name&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">PT</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span><span class="n">mass</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">amu</span><span class="p">})</span>


    <span class="c1">#========== Read the raw coordinates and assign masses ==========</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span> <span class="c1"># coordinates</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsteps</span><span class="p">):</span>

        <span class="c1"># ========== Coordinates =========</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_structure&quot;</span><span class="p">,</span><span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_positions&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;atom&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nat</span><span class="p">):</span>        
            <span class="n">xyz_str</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&lt;xmlattr&gt;/name&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
            <span class="n">D</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
            <span class="n">D</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
            <span class="n">D</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>

            <span class="c1">#=========== And masses ==========</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PT</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PT</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PT</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># ========== Forces  =========</span>
        <span class="n">frcs</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forces&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frcs</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sz</span><span class="p">):</span>        
            <span class="n">xyz_str</span> <span class="o">=</span> <span class="n">frcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cnt</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cnt</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>                 
        
    <span class="c1">#====== Compute velocities and coordinates at the mid-points ========</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsteps</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">):</span>    
            <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">D</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">)</span>
            <span class="n">V</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">D</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">)</span>
            <span class="n">A</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="o">/</span> <span class="n">M</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">E</span></div>



<div class="viewcode-block" id="read_md_data_xyz"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_md_data_xyz">[docs]</a><span class="k">def</span> <span class="nf">read_md_data_xyz</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in the MD trajectory stored in an XYZ format</span>

<span class="sd">    Args:</span>
<span class="sd">        filename ( string ): the name of the xyz file that contains an MD data</span>
<span class="sd">        PT ( dict{ string:float } ): definition of the masses of different atomic species [masses in amu, where 1 is the mass of H]</span>
<span class="sd">        dt ( double ): MD nuclear integration time step [a.u. of time]</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (R, V, M, E), where:</span>

<span class="sd">        * R ( MATRIX(ndof x nsteps-1) ): coordinates of all DOFs for all mid-timesteps [Bohr]</span>
<span class="sd">        * V ( MATRIX(ndof x nsteps-1) ): velocities of all DOFs for all mid-timesteps [a.u. of velocity]</span>
<span class="sd">        * M ( MATRIX(ndof x 1) ): masses of all DOFs [a.u. of mass]</span>
<span class="sd">        * E (list of ndof/3): atom names (elements) of all atoms         </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  <span class="c1"># the number of lines in the file</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># the number of atoms</span>
    <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nlines</span><span class="o">/</span><span class="p">(</span><span class="n">nat</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span> 


    <span class="c1">#========== Read the raw coordinates and assign masses ==========</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span> <span class="c1"># coordinates</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsteps</span><span class="p">):</span>

        <span class="c1"># ========== Coordinates =========</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nat</span><span class="p">):</span>        
            <span class="n">xyz_str</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">nat</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">xyz_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">D</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Angst</span> <span class="p">)</span>
            <span class="n">D</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Angst</span> <span class="p">)</span>
            <span class="n">D</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Angst</span> <span class="p">)</span>

            <span class="c1">#=========== And masses ==========</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PT</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">amu</span><span class="p">)</span>
                <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PT</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">amu</span><span class="p">)</span>
                <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PT</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">amu</span><span class="p">)</span>
                <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


    <span class="c1">#====== Compute velocities and coordinates at the mid-points ========</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsteps</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">):</span>    
            <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">D</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">)</span>
            <span class="n">V</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">D</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">E</span></div>



<div class="viewcode-block" id="read_md_data_xyz2"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_md_data_xyz2">[docs]</a><span class="k">def</span> <span class="nf">read_md_data_xyz2</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">PT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in the MD trajectory stored in an XYZ format</span>
<span class="sd">    This version does not compute velocities - only gets coordinates</span>

<span class="sd">    Args:</span>
<span class="sd">        filename ( string ): the name of the xyz file that contains an MD data</span>
<span class="sd">        PT ( dict{ string:float } ): definition of the masses of different atomic species [masses in amu, where 1 is the mass of H]</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (R, E), where:</span>

<span class="sd">        * R ( MATRIX(ndof x nsteps-1) ): coordinates of all DOFs for all mid-timesteps [Bohr]</span>
<span class="sd">        * E (list of ndof/3): atom names (elements) of all atoms         </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  <span class="c1"># the number of lines in the file</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># the number of atoms</span>
    <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nlines</span><span class="o">/</span><span class="p">(</span><span class="n">nat</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> 


    <span class="c1">#========== Read the raw coordinates and assign masses ==========</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span> <span class="c1"># coordinates</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsteps</span><span class="p">):</span>

        <span class="c1"># ========== Coordinates =========</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nat</span><span class="p">):</span>        
            <span class="n">xyz_str</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">nat</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">xyz_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Angst</span> <span class="p">)</span>
            <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Angst</span> <span class="p">)</span>
            <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Angst</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">E</span></div>




<div class="viewcode-block" id="read_md_data_cell"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_md_data_cell">[docs]</a><span class="k">def</span> <span class="nf">read_md_data_cell</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in the QE MD unit cell vectors stored in an XML file</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (string): the name of the xml file that contains an MD data</span>
<span class="sd">            this function is specifically tailored for the QE output format</span>

<span class="sd">    Returns:</span>
<span class="sd">        MATRIX(9 x nsteps): cell coordinates for all timesteps, in the format [Bohr]: </span>
<span class="sd">                 </span>
<span class="sd">            C(0,0) = a1.x    C(0,1) = a1.y    C(0,2) = a1.z</span>
<span class="sd">            C(1,0) = a2.x    C(1,1) = a2.y    C(1,2) = a2.z</span>
<span class="sd">            C(2,0) = a3.x    C(2,1) = a3.y    C(2,2) = a3.z</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default (empty) context object</span>
    <span class="n">dctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>      
    <span class="n">ctx</span><span class="o">.</span><span class="n">set_path_separator</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>   
    <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

    <span class="c1">#========== Read the raw coordinates and assign masses ==========</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span>     <span class="c1"># cell parameters</span>


    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsteps</span><span class="p">):</span>

        <span class="c1"># ========== Cell =========</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;atomic_structure&quot;</span><span class="p">,</span><span class="n">dctx</span><span class="p">)</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="n">dctx</span><span class="p">)</span>

        <span class="n">a1_str</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">a2_str</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a2&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">a3_str</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a3&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a1_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">);</span>  <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a1_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">);</span>   <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a1_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">);</span>        
        <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a2_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">);</span>  <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a2_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">);</span>   <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a2_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">);</span>        
        <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a3_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">);</span>  <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a3_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">);</span>   <span class="n">C</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a3_str</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">);</span>        
        
    <span class="k">return</span> <span class="n">C</span></div>




<div class="viewcode-block" id="out2inp"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.out2inp">[docs]</a><span class="k">def</span> <span class="nf">out2inp</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span><span class="n">templ_filename</span><span class="p">,</span><span class="n">wd</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd"> </span>
<span class="sd">    Converts a QE output file with an MD trajectory to a bunch of input files</span>
<span class="sd">    for SCF calculations. These input files all have the same control settings,</span>
<span class="sd">    but differ in atomic coordinates</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        out_filename ( string ): name of the file which contains the MD trajectory</span>
<span class="sd">        templ_filename ( string ): name of the template file for input generation</span>
<span class="sd">            should not contain atomic positions! </span>

<span class="sd">        prefix ( string ): the prefix of the files generated as the output</span>
<span class="sd">        wd ( string ): working directory where all files will be created/processed - will be created </span>
<span class="sd">        t0 ( int ): defines the starting timestep to process (not all the MD timesteps may be precessed)</span>
<span class="sd">        tmax ( int ): defines the maximal timestep to process (not all the MD timesteps may be precessed)</span>
<span class="sd">        dt ( int ):  defines the spacing between frames which are written this is defined as a </span>
<span class="sd">            difference between written configuration indexes. So if dt = 5, the following frames</span>
<span class="sd">            will be written: 0,5,10,15, etc...</span>

<span class="sd">    Returns:</span>
<span class="sd">        None: but will create a bunch of new input files in the created working directory</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Read the template file</span>
    <span class="n">f_templ</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">templ_filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">f_templ</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f_templ</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">T_sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">wd</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create working directory and generate the files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wd</span><span class="p">)</span>

    <span class="c1"># Parameters</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># Number of atoms per unit cell</span>
    <span class="n">is_nat</span> <span class="o">=</span> <span class="mi">0</span><span class="c1"># flag defining if nat variable has been set</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag to start reading the coordinates</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># index of the input file</span>
    <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># line with the coordinates of at_line-th atom is being written</span>

    <span class="c1"># Read the file</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading file&quot;</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">f_t</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/tmp&quot;</span> <span class="o">%</span> <span class="n">wd</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f_t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1">#print t</span>
<span class="c1">#        print &quot;is_nat=%d, nat=%d, at_line=%d, start=%d, t=%d&quot; % (is_nat,nat,at_line,start,t)</span>
        <span class="k">if</span> <span class="n">start</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at_line</span><span class="o">&lt;=</span><span class="n">nat</span><span class="p">:</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># A blank line just in case</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">at_line</span> <span class="o">=</span> <span class="n">at_line</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">start</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at_line</span><span class="o">&lt;</span><span class="n">nat</span><span class="p">:</span>
                <span class="n">a_tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a_tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;   &quot;</span><span class="o">+</span><span class="n">a_tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;   &quot;</span><span class="o">+</span><span class="n">a_tmp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="n">a_tmp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># A blank line just in case</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">at_line</span> <span class="o">=</span> <span class="n">at_line</span> <span class="o">+</span> <span class="mi">1</span>


        <span class="k">elif</span> <span class="n">start</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_nat</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>            
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;number of atoms/cell&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                    <span class="n">is_nat</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ATOMIC_POSITIONS&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">t0</span> <span class="ow">and</span> <span class="n">t</span><span class="o">&lt;=</span><span class="n">tmax</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">f_t</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                            <span class="c1"># Write the template header</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">T_sz</span><span class="p">:</span>
                                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="c1"># Write the header for positions</span>
                            <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                            <span class="c1"># Set flag to write positions</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">t</span><span class="o">&gt;</span><span class="n">tmax</span><span class="p">:</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;site n.     atom                  positions (alat units)&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Set flag to write positions</span>
                    <span class="c1">#print &quot;Atomic_positions record is found! nframe=%d t=%d start=%d&quot; % (nframe,t,start)</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">t0</span> <span class="ow">and</span> <span class="n">t</span><span class="o">&lt;=</span><span class="n">tmax</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">f_t</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                            <span class="c1"># Write the template header</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">T_sz</span><span class="p">:</span>
                                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="c1"># Write the header for positions</span>
                            <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ATOMIC_POSITIONS (alat)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="c1"># Set flag to write positions</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">t</span><span class="o">&gt;</span><span class="n">tmax</span><span class="p">:</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>


    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
   




<div class="viewcode-block" id="out2pdb"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.out2pdb">[docs]</a><span class="k">def</span> <span class="nf">out2pdb</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">pdb_prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Converts a QE output file with an MD trajectory to a bunch of pdb files</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        out_filename ( string ): name of the file which contains the MD trajectory.</span>
<span class="sd">            This file is the QE MD trajectory output</span>
<span class="sd">        T ( int ): defines the maximal timestep to process (not all the MD timesteps may be precessed)</span>
<span class="sd">        dt ( int ):  defines the spacing between frames which are written this is defined as a </span>
<span class="sd">            difference between written configuration indexes. So if dt = 5, the following frames</span>
<span class="sd">            will be written: 0,5,10,15, etc...</span>

<span class="sd">    Returns:</span>
<span class="sd">        None: but will create a bunch of new pdb files with the trajectory info, including the unit cell params.</span>


<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; QE_methods.out2pdb(&quot;x.md.out&quot;,250,25,&quot;snaps/snap_&quot;)</span>

<span class="sd">       This will create MD snapshots at times 0 (input configuration), 25 (25-th nuclear configuration), 50, etc.</span>
<span class="sd">       the files will be collcted in the folder /snaps and named snap_0.pdb, snap_25.pdb, snap_50.pdb, etc.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Parameters</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># Number of atoms per unit cell</span>
    <span class="n">is_nat</span> <span class="o">=</span> <span class="mi">0</span><span class="c1"># flag defining if nat variable has been set</span>
    <span class="n">is_a1</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag defining if the cell variables are set</span>
    <span class="n">is_a2</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag defining if the cell variables are set</span>
    <span class="n">is_a3</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag defining if the cell variables are set</span>
    <span class="n">is_alat</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># flag defining scaling constant for the cell</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag to start reading the coordinates</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># index of the input file</span>
    <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># line with the coordinates of at_line-th atom is being written</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="c1"># Read the file</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading file&quot;</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">fr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># time (configuration)</span>

    <span class="n">nframe</span> <span class="o">=</span> <span class="n">dt</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">start</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">&lt;</span><span class="n">T</span> <span class="ow">and</span> <span class="n">nframe</span><span class="o">==</span><span class="n">dt</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at_line</span><span class="o">&lt;</span><span class="n">nat</span><span class="p">:</span>
                <span class="n">tmp</span>  <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">symb</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">r</span>    <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">r</span>    <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                    <span class="n">symb</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">start</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">r</span>    <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">8</span><span class="p">])]</span>
                    <span class="n">symb</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">scl</span>  <span class="o">=</span> <span class="n">alat</span> <span class="o">*</span> <span class="mf">0.52918</span>  <span class="c1"># alat in a.u., coordinates will be in Angstrom</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">elt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symb</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span><span class="o">+</span><span class="n">symb</span>
                    <span class="n">elt</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">symb</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">symb</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="n">symb</span>
                    <span class="n">elt</span> <span class="o">=</span> <span class="n">symb</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span>
             
                <span class="n">fr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ATOM  %5.d </span><span class="si">%s</span><span class="s2"> MOL M%4.d    </span><span class="si">%8.3f%8.3f%8.3f%6.2f%6.2f</span><span class="s2">      XYZ1</span><span class="si">%s</span><span class="s2">  </span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="n">at_line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">scl</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scl</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">scl</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">elt</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nframe</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">at_line</span> <span class="o">=</span> <span class="n">at_line</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">start</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_nat</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>            
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;number of atoms/cell&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                    <span class="c1">#print &quot;nat = %5d&quot; % nat</span>
                    <span class="n">is_nat</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_a1</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a(1) =&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">])]</span>
                    <span class="c1">#print &quot;a1 = &quot;, a1</span>
                    <span class="n">is_a1</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_a2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a(2) =&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">a2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">])]</span>
                    <span class="c1">#print &quot;a2 = &quot;, a2</span>
                    <span class="n">is_a2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_a3</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a(3) =&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">a3</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">])]</span>
                    <span class="c1">#print &quot;a3 = &quot;, a3</span>
                    <span class="n">is_a3</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_alat</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;lattice parameter (alat)  =&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">alat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="c1">#print &quot;alat = &quot;, alat</span>
                    <span class="n">is_alat</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ATOMIC_POSITIONS&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Set flag to write positions</span>
                    <span class="c1">#print &quot;Atomic_positions record is found! nframe=%d t=%d start=%d&quot; % (nframe,t,start)</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nframe</span><span class="o">==</span><span class="n">dt</span><span class="p">:</span>
                            <span class="n">fr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%d</span><span class="s2">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pdb_prefix</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">B</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">C</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">AB</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">AC</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">BC</span> <span class="o">=</span> <span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">gam</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">AB</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">B</span><span class="p">)))</span>
                            <span class="n">bet</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">AC</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">C</span><span class="p">)))</span>
                            <span class="n">alp</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">BC</span><span class="o">/</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">C</span><span class="p">)))</span>

                            <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">alat</span><span class="o">*</span><span class="mf">0.52918</span>
                            <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">*</span><span class="n">alat</span><span class="o">*</span><span class="mf">0.52918</span>
                            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">*</span><span class="n">alat</span><span class="o">*</span><span class="mf">0.52918</span>
                            <span class="n">fr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;CRYST1</span><span class="si">%9.3f%9.3f%9.3f%7.2f%7.2f%7.2f</span><span class="s2"> P 1           1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">alp</span><span class="p">,</span><span class="n">bet</span><span class="p">,</span><span class="n">gam</span><span class="p">))</span>

                            <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">nframe</span> <span class="o">=</span> <span class="n">nframe</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;site n.     atom                  positions (alat units)&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Set flag to write positions</span>
                    <span class="c1">#print &quot;Atomic_positions record is found! nframe=%d t=%d start=%d&quot; % (nframe,t,start)</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nframe</span><span class="o">==</span><span class="n">dt</span><span class="p">:</span>
                            <span class="n">fr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%d</span><span class="s2">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pdb_prefix</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">B</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">C</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">AB</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">AC</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">BC</span> <span class="o">=</span> <span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">gam</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">AB</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">B</span><span class="p">)))</span>
                            <span class="n">bet</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">AC</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">C</span><span class="p">)))</span>
                            <span class="n">alp</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">BC</span><span class="o">/</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">C</span><span class="p">)))</span>

                            <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">alat</span><span class="o">*</span><span class="mf">0.52918</span>
                            <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">*</span><span class="n">alat</span><span class="o">*</span><span class="mf">0.52918</span>
                            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">*</span><span class="n">alat</span><span class="o">*</span><span class="mf">0.52918</span>
                            <span class="n">fr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;CRYST1</span><span class="si">%9.3f%9.3f%9.3f%7.2f%7.2f%7.2f</span><span class="s2"> P 1           1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">alp</span><span class="p">,</span><span class="n">bet</span><span class="p">,</span><span class="n">gam</span><span class="p">))</span>

                            <span class="n">start</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">nframe</span> <span class="o">=</span> <span class="n">nframe</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
           
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
   



<div class="viewcode-block" id="out2xyz"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.out2xyz">[docs]</a><span class="k">def</span> <span class="nf">out2xyz</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">xyz_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  </span>
<span class="sd">    This function converts the QE output file into a .xyz trajectory file. </span>
<span class="sd">    No more than T steps from the out_filename file will be used</span>

<span class="sd">    Args: </span>
<span class="sd">        out_filename ( string ): name of the file which contains the MD trajectory.</span>
<span class="sd">            This file is the QE MD trajectory output</span>
<span class="sd">        T ( int ): defines the maximal timestep to process (not all the MD timesteps may be precessed)</span>
<span class="sd">        dt ( int ):  defines the spacing between frames which are written this is defined as a </span>
<span class="sd">            difference between written configuration indexes. So if dt = 5, the following frames</span>
<span class="sd">            will be written: 0,5,10,15, etc...</span>
<span class="sd">        xyz_filename ( string ): the name of the file to which the resulting .xyz trajectory will be written</span>

<span class="sd">    Returns:</span>
<span class="sd">        None: but will create a .xyz file with the trajectory.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; QE_methods.out2xyz(&quot;x.md.out&quot;,250,25,&quot;snaps/traj.xyz&quot;)</span>

<span class="sd">        This will create the MD trajectory file in .xyz format with the snapshots takes at times 0</span>
<span class="sd">        (input configuration), 25 (25-th nuclear configuration), 50, etc.</span>
<span class="sd">        the snapshots will written in the file trahj.xyz in the folder /snaps </span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="c1">#    dt = dt - 1</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Parameters</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># Number of atoms per unit cell</span>
    <span class="n">is_nat</span> <span class="o">=</span> <span class="mi">0</span><span class="c1"># flag defining if nat variable has been set</span>
    <span class="n">is_a1</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag defining if the cell variables are set</span>
    <span class="n">is_a2</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag defining if the cell variables are set</span>
    <span class="n">is_a3</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag defining if the cell variables are set</span>
    <span class="n">is_alat</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># flag defining scaling constant for the cell</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag to start reading the coordinates</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># index of the input file</span>
    <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># line with the coordinates of at_line-th atom is being written</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="c1"># Read the file</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading file&quot;</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">fr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">xyz_filename</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">xyz_filename</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># time (configuration)</span>

    <span class="n">nframe</span> <span class="o">=</span> <span class="n">dt</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">start</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">&lt;</span><span class="n">T</span> <span class="ow">and</span> <span class="n">nframe</span><span class="o">==</span><span class="n">dt</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at_line</span><span class="o">&lt;</span><span class="n">nat</span><span class="p">:</span>
                <span class="n">tmp</span>  <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">symb</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">r</span>    <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">r</span>    <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                    <span class="n">symb</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">start</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">r</span>    <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">8</span><span class="p">])]</span>
                    <span class="n">symb</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">scl</span>  <span class="o">=</span> <span class="n">alat</span> <span class="o">*</span> <span class="mf">0.52918</span>  <span class="c1"># alat in a.u., coordinates will be in Angstrom</span>
                <span class="n">fr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">   </span><span class="si">%5.3f</span><span class="s2">  </span><span class="si">%5.3f</span><span class="s2">  </span><span class="si">%5.3f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="o">%</span><span class="p">(</span><span class="n">symb</span><span class="p">,</span><span class="n">scl</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scl</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">scl</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nframe</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">at_line</span> <span class="o">=</span> <span class="n">at_line</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">start</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_nat</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>            
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;number of atoms/cell&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                    <span class="c1">#print &quot;nat = %5d&quot; % nat</span>
                    <span class="n">is_nat</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_a1</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a(1) =&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">])]</span>
                    <span class="c1">#print &quot;a1 = &quot;, a1</span>
                    <span class="n">is_a1</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_a2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a(2) =&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">a2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">])]</span>
                    <span class="c1">#print &quot;a2 = &quot;, a2</span>
                    <span class="n">is_a2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_a3</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a(3) =&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">a3</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">])]</span>
                    <span class="c1">#print &quot;a3 = &quot;, a3</span>
                    <span class="n">is_a3</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_alat</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;lattice parameter (alat)  =&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">alat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="c1">#print &quot;alat = &quot;, alat</span>
                    <span class="n">is_alat</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ATOMIC_POSITIONS&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Set flag to write positions</span>
<span class="c1">#                   print &quot;Atomic_positions record is found! nframe=%d t=%d start=%d&quot; % (nframe,t,start)</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nframe</span><span class="o">==</span><span class="n">dt</span><span class="p">:</span>
<span class="c1">#                            print &quot;Start of output&quot;</span>
                            <span class="n">fr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nat</span><span class="p">)</span>
                            <span class="n">fr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;molecule</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">nframe</span> <span class="o">=</span> <span class="n">nframe</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;site n.     atom                  positions (alat units)&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Set flag to write positions</span>
                    <span class="c1">#print &quot;Atomic_positions record is found! nframe=%d t=%d start=%d&quot; % (nframe,t,start)</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nframe</span><span class="o">==</span><span class="n">dt</span><span class="p">:</span>
<span class="c1">#                            print &quot;Start of output&quot;</span>
                            <span class="n">fr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nat</span><span class="p">)</span>
                            <span class="n">fr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;molecule</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="n">start</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">nframe</span> <span class="o">=</span> <span class="n">nframe</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>


    <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
   

<div class="viewcode-block" id="xyz2inp"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.xyz2inp">[docs]</a><span class="k">def</span> <span class="nf">xyz2inp</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span><span class="n">templ_filename</span><span class="p">,</span><span class="n">wd</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Converts a xyz trajectory file with an MD trajectory to a bunch of input files</span>
<span class="sd">    for SCF calculations. These input files all have the same control settings,</span>
<span class="sd">    but differ in atomic coordinates</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        out_filename ( string ): name of the file which contains the MD trajectory (in xyz format)</span>
<span class="sd">        templ_filename ( string ): name of the template file for input generation</span>
<span class="sd">            should not contain atomic positions! </span>

<span class="sd">        wd ( string ): working directory where all files will be created/processed - will be created </span>
<span class="sd">        prefix ( string ): the prefix of the files generated as the output</span>
<span class="sd">        t0 ( int ): defines the starting timestep to process (not all the MD timesteps may be precessed)</span>
<span class="sd">        tmax ( int ): defines the maximal timestep to process (not all the MD timesteps may be precessed)</span>
<span class="sd">        dt ( int ):  defines the spacing between frames which are written this is defined as a </span>
<span class="sd">            difference between written configuration indexes. So if dt = 5, the following frames</span>
<span class="sd">            will be written: 0,5,10,15, etc...</span>

<span class="sd">    Returns:</span>
<span class="sd">        None: but will create a bunch of new input files in the created working directory</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Read the template file</span>
    <span class="n">f_templ</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">templ_filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">f_templ</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f_templ</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">T_sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">wd</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create working directory and generate the files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wd</span><span class="p">)</span>

    <span class="c1"># Parameters</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># Number of atoms per unit cell</span>
    <span class="n">is_nat</span> <span class="o">=</span> <span class="mi">0</span><span class="c1"># flag defining if nat variable has been set</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># flag to start reading the coordinates</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># index of the input file</span>
    <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># line with the coordinates of at_line-th atom is being written</span>

    <span class="c1"># Read the file</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading file&quot;</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">f_t</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/tmp&quot;</span> <span class="o">%</span> <span class="n">wd</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f_t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># for a in the xyz file:</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>

        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">start</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

            <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">is_nat</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">is_nat</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Frame&quot;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">t0</span> <span class="ow">and</span> <span class="n">t</span><span class="o">&lt;=</span><span class="n">tmax</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">f_t</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                            <span class="c1"># Write the template header</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">T_sz</span><span class="p">:</span>
                                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="c1"># Write the header for positions</span>
                            <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ATOMIC_POSITIONS (angstrom)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="c1"># Set flag to write positions</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">at_line</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">t</span><span class="o">&gt;</span><span class="n">tmax</span><span class="p">:</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">start</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at_line</span><span class="o">&lt;=</span><span class="n">nat</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># A blank line just in case</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">at_line</span> <span class="o">=</span> <span class="n">at_line</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>




<div class="viewcode-block" id="get_QE_normal_modes"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.get_QE_normal_modes">[docs]</a><span class="k">def</span> <span class="nf">get_QE_normal_modes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function reads the QE phonon calculations output files</span>
<span class="sd">    to get the key information for further normal modes visualization</span>
<span class="sd">    or other types of calculations related to normal modes  </span>
<span class="sd"> </span>
<span class="sd">    Args:  </span>
<span class="sd">        filename ( string ): the name of a .dyn file produced by QE code</span>
<span class="sd">        verbosity ( int ) to control the amount of printouts</span>

<span class="sd">            * 0 - no extra output (default)</span>
<span class="sd">            * 1 - print extra stuff</span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">        tuple: (Elts, R, U), where:</span>

<span class="sd">        * Elts ( list of nat string ): labels of all atoms, nat - is the number of atoms</span>
<span class="sd">        * R ( MATRIX(3*nat x 1) ): coordinates of all atoms [Angstrom]</span>
<span class="sd">        * U ( MATRIX(ndof x ndof) ): eigenvectors, defining the normal modes</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; get_QE_normal_modes(&quot;silicon.dyn1&quot;, 1)     # verbose output</span>
<span class="sd">        &gt;&gt;&gt; get_QE_normal_modes(&quot;Cs4SnBr6_T200.dyn1&quot;)  # not verbose output</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#========= Read in the file and determine the key dimensions =======</span>
    <span class="n">f</span>   <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">nspec</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># number of types of atoms (species)</span>
    <span class="n">nat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>     <span class="c1"># number of atoms</span>
    <span class="k">if</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> atoms of </span><span class="si">%i</span><span class="s2"> types&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="n">nspec</span><span class="p">))</span>


    <span class="c1">#============= Determine the types of atoms ===============</span>
    <span class="n">pfreq_indx</span> <span class="o">=</span> <span class="s1">&#39;(?P&lt;freq_indx&gt;&#39;</span><span class="o">+</span><span class="n">rgl</span><span class="o">.</span><span class="n">INT</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
    <span class="n">pAtom_type</span> <span class="o">=</span> <span class="s1">&#39;(?P&lt;Atom_type&gt;&#39;</span><span class="o">+</span><span class="n">rgl</span><span class="o">.</span><span class="n">INT</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="o">+</span><span class="n">rgl</span><span class="o">.</span><span class="n">SP</span>
    <span class="n">pAtom_type2</span> <span class="o">=</span> <span class="s1">&#39;(?P&lt;Atom_type2&gt;&#39;</span><span class="o">+</span><span class="n">rgl</span><span class="o">.</span><span class="n">INT</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="o">+</span><span class="n">rgl</span><span class="o">.</span><span class="n">SP</span>
    <span class="n">PHRASE1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">(?P&lt;Atom_element&gt;[a-zA-Z]+)\s+</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">rgl</span><span class="o">.</span><span class="n">SP</span>

    <span class="n">last_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">:</span>        
        <span class="n">m1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pAtom_type</span> <span class="o">+</span> <span class="n">PHRASE1</span> <span class="o">+</span> <span class="n">rgl</span><span class="o">.</span><span class="n">pX_val</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m1</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>           
            <span class="n">ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">m1</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;Atom_type&#39;</span><span class="p">):</span><span class="n">m1</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="s1">&#39;Atom_type&#39;</span><span class="p">)]))</span>
            <span class="n">elt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">m1</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;Atom_element&#39;</span><span class="p">):</span><span class="n">m1</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="s1">&#39;Atom_element&#39;</span><span class="p">)]</span>
            <span class="n">E</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ind</span><span class="p">:</span><span class="n">elt</span><span class="p">})</span>
            <span class="n">last_index</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;atom type index - element type mapping: &quot;</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>


    <span class="c1">#============= Get the coordinates ========================</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Elts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_index</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">nat</span><span class="p">):</span>    
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="n">Elts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cnt</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cnt</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your system&#39;s elements = </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">Elts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your system&#39;s coordinates = </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">show_matrix</span><span class="p">()</span>


    <span class="c1">#=========== Now look for frequencies ===============</span>
    <span class="n">ndof</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">nat</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">MATRIX</span><span class="p">(</span><span class="n">ndof</span><span class="p">,</span> <span class="n">ndof</span><span class="p">)</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;freq \(\s+&#39;</span> <span class="o">+</span> <span class="n">pfreq_indx</span> <span class="o">+</span> <span class="s1">&#39;\) \=\s+&#39;</span> <span class="o">+</span> <span class="n">rgl</span><span class="o">.</span><span class="n">pX_val</span> <span class="o">+</span> <span class="s1">&#39;\[THz\] \=\s+&#39;</span> <span class="o">+</span> <span class="n">rgl</span><span class="o">.</span><span class="n">pY_val</span> <span class="o">+</span> <span class="s1">&#39;\[cm\-1\]\s+&#39;</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sz</span><span class="p">):</span>        
        <span class="n">m1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">m1</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">m1</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;freq_indx&#39;</span><span class="p">):</span><span class="n">m1</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="s1">&#39;freq_indx&#39;</span><span class="p">)]</span> 
            <span class="n">freq1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">m1</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;X_val&#39;</span><span class="p">):</span><span class="n">m1</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="s1">&#39;X_val&#39;</span><span class="p">)]</span> 
            <span class="n">freq2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">m1</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;Y_val&#39;</span><span class="p">):</span><span class="n">m1</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="s1">&#39;Y_val&#39;</span><span class="p">)]</span> 
            <span class="c1">#print ind, freq1, freq2</span>
 
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nat</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

                <span class="n">U</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">U</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">U</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">nat</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Eigenvectors = </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">U</span><span class="o">.</span><span class="n">show_matrix</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">Elts</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">U</span></div>
   





<div class="viewcode-block" id="run_qe"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.run_qe">[docs]</a><span class="k">def</span> <span class="nf">run_qe</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dirname0</span><span class="p">,</span> <span class="n">dirname1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function runs necessary QE calculations as defined by the &quot;params&quot; dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        params ( dictionary ): A dictionary containing important simulation parameters</span>

<span class="sd">            * **params[&quot;BATCH_SYSTEM&quot;]** ( string ): the name of the job submission command</span>
<span class="sd">                use &quot;srun&quot; if run calculations on SLURM system or &quot;mpirun&quot; if run on PBS system</span>
<span class="sd">                [default: &quot;srun&quot;]</span>
<span class="sd">            * **params[&quot;NP&quot;]** ( int ): the number of nodes on which execute calculations</span>
<span class="sd">                [default: 1]</span>
<span class="sd">            * **params[&quot;EXE&quot;]** ( string ): the name of the program to be executed. This may be </span>
<span class="sd">                the absolute path to the QE (pw.x) binary</span>
<span class="sd">            * **params[&quot;EXE_EXPORT&quot;]** ( string ): the name of the program that converts the binary files</span>
<span class="sd">                with the QE wavefunctions to the text format (pw_export.x). The name includes the </span>
<span class="sd">                absolute path to the binary</span>
<span class="sd">            * **params[&quot;prefix0&quot;]** ( string ): the name of scf template input file - it should </span>
<span class="sd">                contain all the parameters controlling the computational methodology for QE.</span>
<span class="sd">                If the file is called &quot;x0.scf.in&quot;, use &quot;x0.scf&quot; as the value of the &quot;prefix0&quot;</span>
<span class="sd">                [default: &quot;x0.scf&quot;]</span>
<span class="sd">            * **params[&quot;prefix1&quot;]** ( string ): the name of scf template input file - it should </span>
<span class="sd">                contain all the parameters controlling the computational methodology for QE.</span>
<span class="sd">                Presently is used for SOC-enabled calculations, whereas the &quot;prefix0&quot; defines the</span>
<span class="sd">                no-SOC calculations. If the file is called &quot;x1.scf.in&quot;, use &quot;x1.scf&quot; as the value</span>
<span class="sd">                of the &quot;prefix1&quot; [default: &quot;x1.scf&quot;]</span>
<span class="sd">            * **params[&quot;nac_method&quot;]** ( int ): selects the type of calculations to perform:</span>
<span class="sd"> </span>
<span class="sd">                - 0 : non-spin-polarized calculations (needs only &quot;prefix0&quot;)</span>
<span class="sd">                - 1 : spin-polarized calculations (needs only &quot;prefix0&quot;)</span>
<span class="sd">                - 2 : non-collinear calculation (SOC) only (needs only &quot;prefix1&quot;)</span>
<span class="sd">                - 3 : spin-polarized and non-collinear calculation (SOC) (needs both &quot;prefix0&quot; and &quot;prefix1&quot;)</span>

<span class="sd">                [default: 0]</span>

<span class="sd">            * **params[&quot;wd&quot;]** ( string ): the name of a &quot;working directory (can be removed once the calculatons</span>
<span class="sd">                are done)&quot; that will be created during this function execution.</span>

<span class="sd">        t ( int ): the current time step</span>
<span class="sd">        dirname0 ( string ): Name of the temporary directory where data will be stored </span>
<span class="sd">            for the case without SOC </span>
<span class="sd">        dirname1 ( string ): Name of the temporary directory where data will be stored </span>
<span class="sd">            for the case with SOC </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tim</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
    <span class="n">tim</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


    <span class="c1"># Now try to get parameters from the input</span>
    <span class="n">critical_params</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;EXE&quot;</span><span class="p">,</span> <span class="s2">&quot;EXE_EXPORT&quot;</span> <span class="p">]</span> 
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;BATCH_SYSTEM&quot;</span><span class="p">:</span><span class="s2">&quot;srun&quot;</span><span class="p">,</span> <span class="s2">&quot;NP&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;prefix0&quot;</span><span class="p">:</span><span class="s2">&quot;x0.scf&quot;</span><span class="p">,</span> <span class="s2">&quot;prefix1&quot;</span><span class="p">:</span><span class="s2">&quot;x1.scf&quot;</span><span class="p">,</span> <span class="s2">&quot;nac_method&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wd&quot;</span><span class="p">:</span><span class="s2">&quot;wd&quot;</span>  <span class="p">}</span>
    <span class="n">comn</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span> <span class="n">critical_params</span><span class="p">)</span>


    <span class="n">BATCH_SYSTEM</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;BATCH_SYSTEM&quot;</span><span class="p">]</span>
    <span class="n">NP</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">]</span>
    <span class="n">EXE</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;EXE&quot;</span><span class="p">]</span>
    <span class="n">EXE_EXPORT</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;EXE_EXPORT&quot;</span><span class="p">]</span>
    <span class="n">prefix0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prefix0&quot;</span><span class="p">]</span>
    <span class="n">prefix1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prefix1&quot;</span><span class="p">]</span>
    <span class="n">nac_method</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;nac_method&quot;</span><span class="p">]</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;wd&quot;</span><span class="p">]</span>

    <span class="c1"># Run calculations</span>
    <span class="c1"># A regular calculation anyway</span>
    <span class="k">if</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">BATCH_SYSTEM</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.in &gt; </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.out&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EXE</span><span class="p">,</span><span class="n">prefix0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">prefix0</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &lt; x0.exp.in &gt; x0.exp.out&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EXE_EXPORT</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -n </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.in &gt; </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">BATCH_SYSTEM</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span><span class="n">EXE</span><span class="p">,</span><span class="n">prefix0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">prefix0</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -n </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &lt; x0.exp.in &gt; x0.exp.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">BATCH_SYSTEM</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span><span class="n">EXE_EXPORT</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Create temporary directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">dirname0</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Copy some results to that directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;mv </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.out </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span> <span class="n">wd</span><span class="p">,</span> <span class="n">dirname0</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;mv *.wfc* </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">dirname0</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;mv x0.export </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">dirname0</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># &quot;x0&quot; - corresponds to x0 as a prefix in input files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;mv x0.save </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">dirname0</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># &quot;x0&quot; - corresponds to x0 as a prefix in input files</span>
                                                                        
    <span class="c1"># Perform the soc calculation on its own, or in addition to the regular one</span>
    <span class="k">if</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">BATCH_SYSTEM</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.in &gt; </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.out&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EXE</span><span class="p">,</span><span class="n">prefix0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">prefix0</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &lt; x0.exp.in &gt; x0.exp.out&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EXE_EXPORT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -n </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.in &gt; </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">BATCH_SYSTEM</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span><span class="n">EXE</span><span class="p">,</span><span class="n">prefix1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">prefix1</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -n </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &lt; x1.exp.in &gt; x1.exp.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">BATCH_SYSTEM</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span><span class="n">EXE_EXPORT</span><span class="p">)</span> <span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span><span class="n">dirname1</span><span class="p">)</span> <span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;mv </span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.out </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span> <span class="n">wd</span><span class="p">,</span> <span class="n">dirname1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;mv *.wfc* </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">dirname1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;mv x1.export </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">dirname1</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># &quot;x1&quot; - corresponds to x1 as a prefix in input files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s2">&quot;mv x1.save </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">dirname1</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># &quot;x1&quot; - corresponds to x1 as a prefix in input files</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The time to run the QE calculations = &quot;</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> <span class="p">)</span></div>



<div class="viewcode-block" id="read_info"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_info">[docs]</a><span class="k">def</span> <span class="nf">read_info</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This fucntions reads the output from QE calculations, and stores the output</span>
<span class="sd">    information in dictionaries</span>

<span class="sd">    Args:</span>
<span class="sd">        params ( dictionary ): Calculation control parameters</span>

<span class="sd">            * **params[&quot;wd&quot;]** ( string ): the name of a &quot;working directory (can be removed once the calculatons</span>
<span class="sd">                are done)&quot; that will be created during this function execution - this is where the temporary files</span>
<span class="sd">                are written to [default: &quot;wd&quot;]</span>
<span class="sd">        </span>
<span class="sd">            * **params[&quot;nac_method&quot;]** ( int ): selects the type of output to analyze:</span>

<span class="sd">                - 0 : non-spin-polarized calculations </span>
<span class="sd">                - 1 : spin-polarized calculations</span>
<span class="sd">                - 2 : non-collinear calculation (SOC) only </span>
<span class="sd">                - 3 : spin-polarized and non-collinear calculation (SOC)</span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">    </span>
<span class="sd">        tuple: ( info0, all_e_dum0, info1, all_e_dum1 ): </span>

<span class="sd">            info0 ( dictionary ): QE calculations info for the spin-diabatic calculations</span>

<span class="sd">            all_e_dum0 ( list of CMATRIX(norb, norb) objects ): (eigen)energies for all the k-points for </span>
<span class="sd">                the spin-diabatic calculations</span>

<span class="sd">            info1 ( dictionary ): QE calculations info for the non-collinear (spin-adiabatic) calculations</span>

<span class="sd">            all_e_dum1 ( list of CMATRIX(norb, norb) objects ): (eigen)energies for all the k-points for </span>
<span class="sd">                the non-collinear (spin-adiabatic) calculations</span>

<span class="sd">            ..seealso:: ```QE_methods.read_qe_index```</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tim</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
    <span class="n">tim</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Now try to get parameters from the input</span>
    <span class="n">critical_params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span> 
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;nac_method&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wd&quot;</span><span class="p">:</span><span class="s2">&quot;wd&quot;</span> <span class="p">}</span>
    <span class="n">comn</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span> <span class="n">critical_params</span><span class="p">)</span>

    <span class="n">nac_method</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;nac_method&quot;</span><span class="p">]</span> 
    <span class="n">wd0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;wd&quot;</span><span class="p">]</span> 



    <span class="n">info0</span><span class="p">,</span> <span class="n">all_e_dum0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">info1</span><span class="p">,</span> <span class="n">all_e_dum1</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># for non-relativistic, non-spin-polarized calculations</span>
    <span class="k">if</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">info0</span><span class="p">,</span> <span class="n">all_e_dum0</span> <span class="o">=</span> <span class="n">read_qe_index</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/curr0/x0.export/index.xml&quot;</span> <span class="o">%</span> <span class="n">wd0</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">info0</span><span class="p">[</span><span class="s2">&quot;nspin&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Error, you are not running the non-relativistic, non-spin-polarized calculation </span><span class="se">\</span>
<span class="s2">                   check your setting with nspin&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;The total # of k-points (non-spin-polarized calculation) is: &quot;</span><span class="p">,</span> <span class="n">info0</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">])</span>

    <span class="c1"># for non-relativistic, spin-polarized calculations</span>
    <span class="k">if</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">info0</span><span class="p">,</span> <span class="n">all_e_dum0</span> <span class="o">=</span> <span class="n">read_qe_index</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/curr0/x0.export/index.xml&quot;</span> <span class="o">%</span> <span class="n">wd0</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">info0</span><span class="p">[</span><span class="s2">&quot;nspin&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Error, you are not running spin-polarized calculations,</span><span class="se">\</span>
<span class="s2">                   check you settings with nspin&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;The total # of k-points (spin-polarized) including up and down components is: &quot;</span><span class="p">,</span> <span class="n">info0</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">])</span>

    <span class="c1"># for fully-relativistic non-collinear calculations</span>
    <span class="k">if</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">nac_method</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">info1</span><span class="p">,</span> <span class="n">all_e_dum1</span> <span class="o">=</span> <span class="n">read_qe_index</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/curr1/x1.export/index.xml&quot;</span> <span class="o">%</span> <span class="n">wd0</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">info1</span><span class="p">[</span><span class="s2">&quot;nspin&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Error,you are not running SOC calculations </span><span class="se">\</span>
<span class="s2">                   check you setting with nspin. Also, veriy that you use fully-relativistic pseudopotentials&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;The total # of k-points (soc) is: &quot;</span><span class="p">,</span> <span class="n">info1</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;The time to get the basic parameters about your QE calculations = &quot;</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span> 

    <span class="k">return</span> <span class="n">info0</span><span class="p">,</span> <span class="n">all_e_dum0</span><span class="p">,</span> <span class="n">info1</span><span class="p">,</span> <span class="n">all_e_dum1</span></div>
    



<div class="viewcode-block" id="read_all"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_all">[docs]</a><span class="k">def</span> <span class="nf">read_all</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This function reads index, wfc and grid files from a given directory</span>
<span class="sd">    The number of wfc and grid files may be larger than 1 - this is the</span>
<span class="sd">    case of spin-polarized or multiple k-points calculations</span>

<span class="sd">    Args:</span>

<span class="sd">    params ( dictionary ): Parameters controlling the simulation parameters</span>

<span class="sd">        * **params[&quot;wd&quot;]** ( string ): the name of a &quot;working directory (can be removed once the calculatons</span>
<span class="sd">            are done)&quot; that will be created during this function execution - this is where the temporary files</span>
<span class="sd">            are written to [default: &quot;wd&quot;]</span>

<span class="sd">        * **params[&quot;prefix&quot;]** ( string ): the location of the folder containing index.xml, wfc.*, and grid.* files [default: &quot;x0.export&quot; ]</span>
<span class="sd">        * **params[&quot;read_wfc&quot;]** ( 0 or 1 ): whether or not to read the wfc coefficients. [ default: 1 ]</span>
<span class="sd">        * **params[&quot;read_grid&quot;]** ( 0 or 1 ): whether or not to read the grid informations. [ default: 1 ]</span>
<span class="sd">        * **params[&quot;verb0&quot;]** ( 0 or 1 ): turn off/on the extra printout while reading index.xml. [ default: 0 ]</span>
<span class="sd">        * **params[&quot;verb1&quot;]** ( 0 or 1 ): turn off/on the extra printout while reading wfc.*. [ default: 0 ]</span>
<span class="sd">        * **params[&quot;verb2&quot;]** ( 0 or 1 ): turn off/on the extra printout while reading grid.*. [ default: 0 ]</span>
<span class="sd">        * **params[&quot;nac_method&quot;]** ( 0, 1, 2 ): the expectations about what format to read:</span>

<span class="sd">            - 0 - non-SOC, non-polarized</span>
<span class="sd">            - 1 - non-SOC, spin-polarized</span>
<span class="sd">            - 2 - SOC, non-collinear</span>

<span class="sd">        * **params[&quot;minband&quot;]** ( int ): index of the lowest energy orbital to include</span>
<span class="sd">            in the active space, counting starts from 1 [ default: 1]</span>

<span class="sd">        * **params[&quot;maxband&quot;]** ( int ): index of the highest energy orbital to include </span>
<span class="sd">            in the active space, counting starts from 1 [ defaults: 2]</span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">        tuple: ( info, e, coeff, grid ), where </span>

<span class="sd">            * info ( dictionary ): general descritor info ..seealso::```QE_methods.read_qe_index```</span>
<span class="sd">            * e ( list of CMATRIX(norbs, norbs) ): band energies for each k-pints  ..seealso::```QE_methods.read_qe_index```</span>
<span class="sd">            * coeff ( list of CMATRIX(npw, len(act_space)) objects ): such the </span>
<span class="sd">                coeff[k] are the MOs in the plane wave basis for the k-point k</span>
<span class="sd">            * grid ( list of VECTOR objects ): the grid point vectors [ units: tpiba ]</span>

<span class="sd">            The number of elements in each list is determined by the number of k points</span>
<span class="sd">            Note that, for spin-polarized calculations, the number of k-points is always twice</span>
<span class="sd">            that of the non-spin-polarized or non-collinear k-points</span>
<span class="sd">    &quot;&quot;&quot;</span>  

    <span class="n">tim</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
    <span class="n">tim</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Now try to get parameters from the input</span>
    <span class="n">critical_params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span> 
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;wd&quot;</span><span class="p">:</span><span class="s2">&quot;wd&quot;</span> <span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span><span class="s2">&quot;x0.export&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;read_wfc&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;read_grid&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> 
                       <span class="s2">&quot;verb0&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;verb1&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;verb2&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> 
                       <span class="s2">&quot;nac_method&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;minband&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;maxband&quot;</span><span class="p">:</span><span class="mi">2</span> 
                     <span class="p">}</span>
    <span class="n">comn</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span> <span class="n">critical_params</span><span class="p">)</span>

    <span class="n">wd</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;wd&quot;</span><span class="p">]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span>
    <span class="n">is_wfc</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;read_wfc&quot;</span><span class="p">]</span>
    <span class="n">is_grd</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;read_grid&quot;</span><span class="p">]</span>
    <span class="n">verb0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;verb0&quot;</span><span class="p">]</span>
    <span class="n">verb1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;verb1&quot;</span><span class="p">]</span>
    <span class="n">verb2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;verb2&quot;</span><span class="p">]</span>
    <span class="n">nac_method</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;nac_method&quot;</span><span class="p">]</span>
    <span class="n">minband</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;minband&quot;</span><span class="p">]</span>
    <span class="n">maxband</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;maxband&quot;</span><span class="p">]</span>

    <span class="k">if</span><span class="p">(</span><span class="n">minband</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">):</span> 
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Error: minband should be &gt;0, current value of minband = &quot;</span><span class="p">,</span><span class="n">minband</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">minband</span><span class="o">&gt;</span><span class="n">maxband</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Error: minband must be smaller or equal to maxband. Current values: minband = &quot;</span><span class="p">,</span><span class="n">minband</span><span class="p">,</span><span class="s2">&quot; maxband = &quot;</span><span class="p">,</span><span class="n">maxband</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;printing prefix:  &quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>

    <span class="n">act_space</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="k">if</span><span class="p">(</span><span class="n">nac_method</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">nac_method</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">file0</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">/index.xml&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="n">act_space</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">minband</span><span class="p">,</span> <span class="n">maxband</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>              <span class="c1"># min = 1, max = 2 =&gt; range(1,3) = [1,2]</span>

        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Reading index from file &quot;</span><span class="p">,</span> <span class="n">file0</span><span class="p">)</span>
        <span class="n">info</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">read_qe_index</span><span class="p">(</span><span class="n">file0</span><span class="p">,</span> <span class="n">act_space</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">nac_method</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">file1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">/index.xml&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="n">act_space</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">minband</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">maxband</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span>   <span class="c1"># min =1, max = 2 =&gt; range(1,5) = [1,2,3,4]</span>

        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Reading index from file &quot;</span><span class="p">,</span> <span class="n">file1</span><span class="p">)</span>
        <span class="n">info</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">read_qe_index</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">act_space</span><span class="p">,</span> <span class="n">verb0</span><span class="p">)</span>


    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;nk&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Handling the k-point </span><span class="si">%i</span><span class="s2"> with coordinates: </span><span class="si">%8.5f</span><span class="s2"> </span><span class="si">%8.5f</span><span class="s2"> </span><span class="si">%8.5f</span><span class="s2"> &quot;</span> \
         <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_wfc</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">file2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">/wfc.</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ik</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Reading the wfc from file &quot;</span><span class="p">,</span><span class="n">file2</span><span class="p">)</span>
            <span class="n">coeff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">read_qe_wfc</span><span class="p">(</span><span class="n">file2</span><span class="p">,</span> <span class="n">act_space</span><span class="p">,</span> <span class="n">verb1</span><span class="p">))</span>   <span class="c1"># CMATRIX(npw x len(act_space))</span>

        <span class="k">if</span> <span class="n">is_grd</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">file3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">/grid.</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ik</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Reading the grid from file &quot;</span><span class="p">,</span> <span class="n">file3</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">read_qe_wfc_grid</span><span class="p">(</span><span class="n">file3</span> <span class="p">,</span> <span class="n">verb2</span><span class="p">)</span> <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;The time to read index, wavefunctions, and grid about your QE calculations = &quot;</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">grid</span></div>




<div class="viewcode-block" id="read_wfc_grid"><a class="viewcode-back" href="../../reference/libra_py/QE_methods.html#libra_py.QE_methods.read_wfc_grid">[docs]</a><span class="k">def</span> <span class="nf">read_wfc_grid</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Read the coefficients and energies for the multi k-points cases, </span>
<span class="sd">    even if some cases require gamma only</span>

<span class="sd">    Args:</span>
<span class="sd">        params ( dictionary ): The control parameters, which may contain:</span>

<span class="sd">            * **param[&quot;nac_method&quot;]** ( 0, 1, 2, 3 ): the expectations about what format to read:</span>

<span class="sd">                - 0 : non-spin-polarized calculations [ default ]</span>
<span class="sd">                - 1 : spin-polarized calculations</span>
<span class="sd">                - 2 : non-collinear calculation (SOC) only </span>
<span class="sd">                - 3 : spin-polarized and non-collinear calculation (SOC)</span>

<span class="sd">            * **params[&quot;minband&quot;]** ( int ): index of the lowest energy orbital to include</span>
<span class="sd">                in the active space in the non-SOC (spin-diabatic) calculations, </span>
<span class="sd">                counting starts from 1. Used for nac_method == 0, 1, 3. [ default: 1]</span>
<span class="sd">            * **params[&quot;maxband&quot;]** ( int ): index of the highest energy orbital to include </span>
<span class="sd">                in the active space  in the non-SOC (spin-diabatic) calculations, </span>
<span class="sd">                counting starts from 1. Used for nac_method == 0, 1, 3. [ defaults: 2]</span>
<span class="sd">            * **params[&quot;minband_soc&quot;]** ( int ): index of the lowest energy orbital pair to include</span>
<span class="sd">                in the active space in the SOC (spin-adiabatic) calculations, </span>
<span class="sd">                counting starts from 1. Used for nac_method == 2 and 3. [ default: 1]</span>
<span class="sd">            * **params[&quot;maxband_soc&quot;]** ( int ): index of the highest energy orbital pair to include </span>
<span class="sd">                in the active space  in the SOC (spin-adiabatic) calculations, </span>
<span class="sd">                counting starts from 1. Used for nac_method == 2 and 3. [ defaults: 2]</span>
<span class="sd">         </span>
<span class="sd">  </span>
<span class="sd">    Returns: </span>
<span class="sd">        tuple: ( res_curr, res_next ), Here _curr, refers to the current timestep properties,</span>
<span class="sd">            and the _next refers to the consecutive timestep properties. Each element of the </span>
<span class="sd">            output is a dictionary with the following elements:</span>

<span class="sd">            * **res_curr[&quot;Coeff_dia&quot;]** ( list of CMATRIX(npw, len(act_space)) objects ) : the </span>
<span class="sd">                wavefunction coefficients in the planewave basis for the spin-diabatic wavefunctions, such</span>
<span class="sd">                that res_curr[&quot;Coeff_dia&quot;][k] is a matrix for the k-point with index k.</span>
<span class="sd">                Only for nac_method == 0, 1, and 3. </span>

<span class="sd">            * **res_curr[&quot;E_dia&quot;]** ( list of MATRIX(len(act_space), len(act_space)) objects ) : the MO</span>
<span class="sd">                energies for the spin-diabatic wavefunctions, such</span>
<span class="sd">                that res_curr[&quot;E_dia&quot;][k] is a matrix for the k-point with index k.</span>
<span class="sd">                Only for nac_method == 0, 1, and 3. </span>

<span class="sd">            * **res_curr[&quot;Coeff_adi&quot;]** ( list of CMATRIX(npw, len(act_space)) objects ) : the </span>
<span class="sd">                wavefunction coefficients in the planewave basis for the spin-adiabatic wavefunctions, such</span>
<span class="sd">                that res_curr[&quot;Coeff_adi&quot;][k] is a matrix for the k-point with index k.</span>
<span class="sd">                Only for nac_method == 2 and 3. </span>

<span class="sd">            * **res_curr[&quot;E_adi&quot;]** ( list of MATRIX(len(act_space), len(act_space)) objects ) : the MO</span>
<span class="sd">                energies for the spin-adiabatic wavefunctions, such</span>
<span class="sd">                that res_curr[&quot;E_adi&quot;][k] is a matrix for the k-point with index k.</span>
<span class="sd">                Only for nac_method == 2 and 3. </span>

<span class="sd">            * **res_curr[&quot;grid&quot;]** ( list of VECTOR objects ): the grid point vectors [ units: tpiba ]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tim</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
    <span class="n">tim</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


    <span class="c1"># Now try to get parameters from the input</span>
    <span class="n">critical_params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span> 
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;nac_method&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;orthogonalize&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                       <span class="s2">&quot;minband&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;maxband&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> 
                       <span class="s2">&quot;minband_soc&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;maxband_soc&quot;</span><span class="p">:</span><span class="mi">2</span>
                     <span class="p">}</span>
    <span class="n">comn</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">,</span> <span class="n">critical_params</span><span class="p">)</span>


    <span class="n">nac_method</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;nac_method&quot;</span><span class="p">]</span>
    <span class="n">orthogonalize</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;orthogonalize&quot;</span><span class="p">]</span>
    <span class="n">minband</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;minband&quot;</span><span class="p">]</span>
    <span class="n">maxband</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;maxband&quot;</span><span class="p">]</span>
    <span class="n">minband_soc</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;minband_soc&quot;</span><span class="p">]</span>
    <span class="n">maxband_soc</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;maxband_soc&quot;</span><span class="p">]</span>


    <span class="n">params_nosoc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">params_soc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">params_soc</span><span class="p">[</span><span class="s2">&quot;minband&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;minband_soc&quot;</span><span class="p">]</span>
    <span class="n">params_soc</span><span class="p">[</span><span class="s2">&quot;maxband&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;maxband_soc&quot;</span><span class="p">]</span>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Here, adi - refers to spin-adiabatic (2-component spinor functions)</span>
<span class="sd">    Here, dia - refers to spin-diabatic (regular functions)</span>
<span class="sd">     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res_curr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Coeff_dia&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;E_dia&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Coeff_adi&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;E_adi&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">res_next</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Coeff_dia&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;E_dia&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Coeff_adi&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;E_adi&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

                
    <span class="k">if</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>

        <span class="c1">#====== Current electronic structure ========</span>
        <span class="n">params_nosoc</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;curr0/x0.export&quot;</span>
        <span class="n">info_curr</span><span class="p">,</span> <span class="n">e_curr</span><span class="p">,</span> <span class="n">coeff_curr</span><span class="p">,</span> <span class="n">grid_curr</span> <span class="o">=</span> <span class="n">read_all</span><span class="p">(</span><span class="n">params_nosoc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orthogonalize</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Do internal orbital orthogonalization&quot;</span><span class="p">)</span>
            <span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QE_utils</span><span class="o">.</span><span class="n">orthogonalize_orbitals</span><span class="p">(</span><span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">id1</span> <span class="o">=</span> <span class="n">CMATRIX</span><span class="p">(</span><span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_of_cols</span><span class="p">,</span> <span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_of_cols</span><span class="p">)</span>
            <span class="n">id1</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="p">(</span><span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">H</span><span class="p">()</span> <span class="o">*</span> <span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">id1</span><span class="p">)</span><span class="o">.</span><span class="n">max_elt</span><span class="p">()</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Error</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


        <span class="n">C_dia_curr</span><span class="p">,</span> <span class="n">E_dia_curr</span> <span class="o">=</span> <span class="n">QE_utils</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">coeff_curr</span><span class="p">,</span> <span class="n">e_curr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">res_curr</span><span class="p">[</span><span class="s2">&quot;Coeff_dia&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_dia_curr</span>
        <span class="n">res_curr</span><span class="p">[</span><span class="s2">&quot;E_dia&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_dia_curr</span>
        <span class="n">res_curr</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_curr</span>

        <span class="c1">#====== Next electronic structure ===========</span>
        <span class="n">params_nosoc</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;next0/x0.export&quot;</span>
        <span class="n">info_next</span><span class="p">,</span> <span class="n">e_next</span><span class="p">,</span> <span class="n">coeff_next</span><span class="p">,</span> <span class="n">grid_next</span> <span class="o">=</span> <span class="n">read_all</span><span class="p">(</span><span class="n">params_nosoc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orthogonalize</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Do internal orbital orthogonalization&quot;</span><span class="p">)</span>
            <span class="n">coeff_next</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QE_utils</span><span class="o">.</span><span class="n">orthogonalize_orbitals</span><span class="p">(</span><span class="n">coeff_next</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">C_dia_next</span><span class="p">,</span> <span class="n">E_dia_next</span> <span class="o">=</span> <span class="n">QE_utils</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">coeff_next</span><span class="p">,</span> <span class="n">e_next</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">res_next</span><span class="p">[</span><span class="s2">&quot;Coeff_dia&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_dia_next</span>
        <span class="n">res_next</span><span class="p">[</span><span class="s2">&quot;E_dia&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_dia_next</span>
        <span class="n">res_next</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_next</span>


    <span class="k">if</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">nac_method</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>

        <span class="c1">#====== Current electron electructure =======</span>
        <span class="n">params_soc</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;curr1/x1.export&quot;</span>
        <span class="n">params_soc</span><span class="p">[</span><span class="s2">&quot;nac_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">info_curr</span><span class="p">,</span> <span class="n">e_curr</span><span class="p">,</span> <span class="n">coeff_curr</span><span class="p">,</span> <span class="n">grid_curr</span> <span class="o">=</span> <span class="n">read_all</span><span class="p">(</span><span class="n">params_soc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orthogonalize</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Do internal orbital orthogonalization&quot;</span><span class="p">)</span>
            <span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QE_utils</span><span class="o">.</span><span class="n">orthogonalize_orbitals</span><span class="p">(</span><span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">id1</span> <span class="o">=</span> <span class="n">CMATRIX</span><span class="p">(</span><span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_of_cols</span><span class="p">,</span> <span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_of_cols</span><span class="p">)</span>
            <span class="n">id1</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="p">(</span><span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">H</span><span class="p">()</span> <span class="o">*</span> <span class="n">coeff_curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">id1</span><span class="p">)</span><span class="o">.</span><span class="n">max_elt</span><span class="p">()</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Error</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">C_adi_curr</span><span class="p">,</span> <span class="n">E_adi_curr</span> <span class="o">=</span> <span class="n">QE_utils</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">coeff_curr</span><span class="p">,</span> <span class="n">e_curr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res_curr</span><span class="p">[</span><span class="s2">&quot;Coeff_adi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_adi_curr</span>
        <span class="n">res_curr</span><span class="p">[</span><span class="s2">&quot;E_adi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_adi_curr</span>
        <span class="n">res_curr</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_curr</span>

       
        <span class="c1">#====== Next electronic structure ===========</span>
        <span class="n">params_soc</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;next1/x1.export&quot;</span>
        <span class="n">params_soc</span><span class="p">[</span><span class="s2">&quot;nac_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">info_next</span><span class="p">,</span> <span class="n">e_next</span><span class="p">,</span> <span class="n">coeff_next</span><span class="p">,</span> <span class="n">grid_next</span> <span class="o">=</span> <span class="n">read_all</span><span class="p">(</span><span class="n">params_soc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orthogonalize</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Do internal orbital orthogonalization&quot;</span><span class="p">)</span>
            <span class="n">coeff_next</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QE_utils</span><span class="o">.</span><span class="n">orthogonalize_orbitals</span><span class="p">(</span><span class="n">coeff_next</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">C_adi_next</span><span class="p">,</span> <span class="n">E_adi_next</span> <span class="o">=</span> <span class="n">QE_utils</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">coeff_next</span><span class="p">,</span> <span class="n">e_next</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res_next</span><span class="p">[</span><span class="s2">&quot;Coeff_adi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_adi_next</span>
        <span class="n">res_next</span><span class="p">[</span><span class="s2">&quot;E_adi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_adi_next</span>
        <span class="n">res_next</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_next</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to read index, wfc, and wfc grids = &quot;</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">res_curr</span><span class="p">,</span> <span class="n">res_next</span></div>


</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Alexey V. Akimov.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>